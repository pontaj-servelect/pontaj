<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SERVELECT â€¢ Pontaj & Concedii</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon.png" />
  <meta name="theme-color" content="#516A75"/>
  <style>
    :root{
      --brand:#516B74;
      --brand-weak:rgba(81,106,117,0.88);
      --accent:#95CA4B;
      --text:#0f172a;
      --muted:#5b6b73;
      --bg:#f4f7f9;
      --card:#ffffff;
      --ring:#cfe0e7;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%; width:100%}
    body{
      margin:0;
      font-family: Montserrat, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        linear-gradient(180deg, rgba(149, 202, 75, 0.91) 0%, rgba(81, 106, 117, 0.88) 66%),
        url('background.jpg');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height:100vh;
    }
    .shell{max-width:1100px;margin:0 auto;padding:24px;}
    .nav{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;padding:14px 16px;border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.80));
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 30px rgba(81,106,117,.18);
      border:1px solid rgba(81,106,117,.18);
    }
    .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
    .brand img{ width:38px;height:38px;object-fit:contain;aspect-ratio:1/1;border-radius:10px;box-shadow:0 3px 10px rgba(81,106,117,.25) }
    .brand h1{font-size:18px;letter-spacing:.2px;margin:0;line-height:1.1}
    .brand h1 span{display:block;font-weight:700}
    .brand small{display:block;font-size:12px;color:var(--muted);margin-top:2px}
    .hero{ margin-top:20px; display:grid;grid-template-columns:1.1fr .9fr;gap:24px;align-items:stretch; }
    @media (max-width:900px){ .hero{grid-template-columns:1fr} }
    .card{ background:var(--card); border:1px solid rgba(14,165,233,.12); border-radius:18px; box-shadow: 0 20px 60px rgba(2,132,199,.08); }
    .panel{padding:20px 20px 14px 20px}
    .panel header{ display:flex;align-items:center;gap:10px;margin:6px 0 14px; }
    .panel header .dot{ width:10px;height:10px;border-radius:50%;background:var(--accent); box-shadow:0 0 0 4px rgba(149,202,75,0.18); }
    .panel header h2{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:14px;margin:0 0 14px}
    label{display:block;font-size:12px;color:var(--muted);margin:4px 0 6px}
    .grid{display:grid;gap:14px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){ .grid.cols-3,.grid.cols-2{grid-template-columns:1fr} }
    select, input[type="text"], input[type="email"], input[type="date"]{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;
      font-size:15px;outline:none;transition: box-shadow .15s, border-color .15s;
    }
    select:focus, input:focus{ border-color: var(--brand); box-shadow:0 0 0 4px var(--ring); }
    .btnbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .btn{ --bg:#e2e8f0; --fg:#0f172a; appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;
      cursor:pointer;transition: transform .06s ease, box-shadow .2s ease, background .2s; box-shadow:0 6px 16px rgba(15,23,42,.08);
      color:var(--fg);background:var(--bg); }
    .btn:active{transform: translateY(1px)}
    .btn.primary{ --bg: var(--accent); --fg:#fff }
    .btn.pause{ --bg:#f59e0b; --fg:#111827 }
    .btn.unpause{ --bg: var(--brand); --fg:#fff }
    .btn.finish{ --bg: var(--accent); --fg:#fff }
    .btn.extra{ --bg:#64748b; --fg:#fff }
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .btn-slot{display:inline-flex;}
    .leave{ border:1px dashed #cbd5e1;border-radius:14px;padding:12px;background:#f8fafc; }
    .kicker{font-size:12px;color:var(--muted);margin-bottom:6px}
    .status{font-size:13px;color:var(--muted);margin-top:10px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;white-space:pre-wrap}
    .chip{ display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(81,106,117,.10);color:#2f3e45;font-weight:600;font-size:12px }
    .chip-menu{
      position:relative;
      cursor:pointer;
      padding-right:4px;
    }
    .chip-main{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chip-label{
      white-space:nowrap;
      max-width:160px;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chip-burger{
      border:none;
      background:transparent;
      padding:4px;
      border-radius:999px;
      display:flex;
      flex-direction:column;
      gap:3px;
      cursor:pointer;
    }
    .chip-burger .burger-line{
      width:14px;
      height:2px;
      border-radius:999px;
      background:#2f3e45;
      transition: transform .18s ease, opacity .18s ease;
    }
    .chip.open .chip-burger .burger-line:nth-child(1){
      transform: translateY(5px) rotate(45deg);
    }
    .chip.open .chip-burger .burger-line:nth-child(2){
      opacity:0;
    }
    .chip.open .chip-burger .burger-line:nth-child(3){
      transform: translateY(-5px) rotate(-45deg);
    }

    .chip-dropdown{
      position:absolute;
      right:0;
      top:100%;
      margin-top:8px;
      min-width:260px;
      background:#ffffff;
      border-radius:14px;
      box-shadow:0 14px 40px rgba(15,23,42,.26);
      padding:12px;
      border:1px solid rgba(15,23,42,.08);
      opacity:0;
      transform:translateY(-4px);
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:50;
    }
    .chip.open .chip-dropdown{
      opacity:1;
      transform:translateY(0);
      pointer-events:auto;
    }

    .chip-dropdown-section{ margin-bottom:8px; }
    .chip-dropdown-section:last-child{ margin-bottom:0; }

    .chip-dropdown-title{
      font-size:13px;
      font-weight:700;
      margin-bottom:6px;
    }
    .chip-field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
      margin-bottom:6px;
    }
    .chip-field span{
      opacity:.8;
    }
    .chip-field input{
      font-size:13px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      outline:none;
    }
    .chip-field input:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 2px var(--ring);
    }

    .chip-btn{
      width:100%;
      margin-top:4px;
      border:none;
      border-radius:10px;
      padding:8px 10px;
      font-size:13px;
      font-weight:600;
      background:var(--brand);
      color:#ffffff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .chip-btn-secondary{
      background:var(--accent);
      color:#0f172a;
    }
    .chip-btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    .chip-link-btn{
      margin-top:4px;
      border:none;
      background:transparent;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      text-decoration:underline;
      padding:4px 0 0;
    }
    .chip-hint{
      margin-top:4px;
      font-size:11px;
    }
    .chip-hint.ok{ color:#15803d; }
    .chip-hint.err{ color:#b91c1c; }
    .chip-hint.warn{ color:#a16207; }

    .rail{padding:18px}
    .summary{ display:grid;gap:12px }
    .summary .item{ display:flex;align-items:center;gap:10px;padding:12px;border-radius:14px;background:#f8fafc;border:1px solid #e2e8f0; }
    .footer{ margin-top:18px;font-size:12px;color:var(--muted);text-align:center }
    .ok{color:#15803d} .err{color:#ef4444} .warn{color:#a16207}

    .toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 24px; z-index: 9999; min-width: 280px; max-width: 92vw;
      background: #0f172a; color: #fff; border-radius: 14px; padding: 14px 16px;
      box-shadow: 0 20px 50px rgba(2,6,23,.35); display:none; font-size:14px
    }
    .toast.ok{ background:#166534 }
    .toast.warn{ background:#a16207 }
    .toast.err{ background:#991b1b }
    .toast .small{opacity:.85;font-size:12px;margin-top:4px}

    body.action-lock .btnbar { pointer-events: none; }
    body.action-lock .btnbar .btn { opacity:.6; cursor:not-allowed; }

    /* ===== SPLASH ===== */
    .splash{ position:fixed; inset:0; z-index:2000; display:grid; place-items:center;
      background: radial-gradient(1200px 800px at 50% 20%, #e8f2e0, #d9e6df);
      opacity:1; transform:scale(1); transition: opacity .6s ease, transform .6s ease; }
    .splash.hide{ opacity:0; transform:scale(1.01); pointer-events:none }
    .s-wrap{ width:min(1100px, 92vw); text-align:center; user-select:none }
    .brand-line{ display:flex; align-items:center; justify-content:center; gap: clamp(10px, 2vw, 22px);
      line-height:1; flex-wrap:wrap; }
    .brand-word{ font-weight:800; letter-spacing:.5px; font-size: clamp(44px, 9vw, 96px); }
    .serv{ color:var(--brand) } .lect{ color:var(--accent) }
    .battery{ height: clamp(110px, 20vw, 190px); width:auto; display:block;
              filter: drop-shadow(0 8px 24px rgba(0,0,0,.08)); }
    .bat-outline{ stroke:var(--brand); stroke-width:10; fill:none; stroke-linejoin:round }
    .bat-cap{ fill:var(--brand) }
    .bar{ opacity:.18; fill:transparent; stroke:var(--brand); stroke-width:2; transition: opacity .2s ease }
    .bar.on{ opacity:1; fill:currentColor; stroke:transparent }
    .bar.stage-red{ color:#ef4444 } .bar.stage-yellow{ color:#f59e0b } .bar.stage-green{ color:var(--accent) }
    .glow{ filter: drop-shadow(0 0 0 rgba(149,202,75,0)); transition: filter .5s ease }
    .glow.active{ filter: drop-shadow(0 0 14px rgba(149,202,75,.75)) drop-shadow(0 0 28px rgba(149,202,75,.45)); }
    .tag{ margin-top: clamp(10px, 2.2vw, 18px); font-weight:700; font-size: clamp(18px, 3.6vw, 34px); line-height:1.15; }
    @media (prefers-reduced-motion: reduce){ .glow, .bar, .splash{ transition:none } }
  </style>
</head>
<body>
  <!-- ===== SPLASH OVERLAY ===== -->
  <div id="splash" class="splash" role="dialog" aria-label="Ecran de Ã®ntÃ¢mpinare">
    <div class="s-wrap">
      <div class="brand-line">
        <div class="brand-word serv">SERV</div>
        <svg class="battery glow" id="battery" viewBox="0 0 150 240" role="img" aria-label="Baterie">
          <rect x="20" y="40" width="110" height="180" rx="14" class="bat-outline"/>
          <rect x="57" y="10" width="36" height="20" rx="6" class="bat-cap"/>
          <rect id="bar1" class="bar" x="32" y="174" width="86" height="32" rx="8"/>
          <rect id="bar2" class="bar" x="32" y="130" width="86" height="32" rx="8"/>
          <rect id="bar3" class="bar" x="32" y="86"  width="86" height="32" rx="8"/>
        </svg>
        <div class="brand-word lect">LECT</div>
      </div>
      <div class="tag">
        <span class="money">Energy is money!</span>
        &nbsp;<span class="save">We save both.</span>
      </div>
    </div>
  </div>
  <!-- ===== END SPLASH ===== -->

  <div class="shell">
    <nav class="nav card">
      <a class="brand" href="#" aria-label="Spre Ã®nceput">
        <img src="favicon.png" alt="SiglÄƒ SERVELECT" />
        <div>
          <h1><span>SERVELECT</span><small>Pontaj & Management Concedii</small></h1>
        </div>
      </a>

      <!-- CHIP CONFIG + HAMBURGER + ADMIN LOGIN -->
      <div class="chip chip-menu" id="cfg">
        <div class="chip-main">
          <span class="chip-label" id="cfgLabel">Se Ã®ncarcÄƒ configuraÈ›iaâ€¦</span>
          <button type="button" class="chip-burger" id="cfgToggle" aria-label="Deschide meniul de configurare">
            <span class="burger-line"></span>
            <span class="burger-line"></span>
            <span class="burger-line"></span>
          </button>
        </div>

        <div class="chip-dropdown" id="cfgDropdown" aria-hidden="true">
          <!-- Stare: NELOGAT -->
          <div class="chip-dropdown-section" id="adminLoginSection">
            <div class="chip-dropdown-title">Admin panel</div>
            <div class="chip-field">
              <span>Utilizator</span>
              <input type="text" id="adminUser" autocomplete="username" />
            </div>
            <div class="chip-field">
              <span>ParolÄƒ</span>
              <input type="password" id="adminPass" autocomplete="current-password" />
            </div>
            <button type="button" class="chip-btn" id="adminLoginBtn">Autentificare</button>
            <div class="chip-hint" id="adminLoginHint"></div>
          </div>

          <!-- Stare: LOGAT -->
          <div class="chip-dropdown-section" id="adminLoggedSection" hidden>
            <div class="chip-dropdown-title">
              Salut, <span id="adminName">Admin</span>
            </div>
            <button type="button" class="chip-btn chip-btn-secondary" id="goAdminBtn">
              Deschide dashboard
            </button>
            <button type="button" class="chip-link-btn" id="adminLogoutBtn">
              Deconectare
            </button>
          </div>
        </div>
      </div>
    </nav>

    <section class="hero">
      <div class="card panel">
        <header>
          <span class="dot" aria-hidden="true"></span>
          <h2>ÃŽnregistrare activitate</h2>
        </header>
        <p class="sub">
          Alege <b>Departament</b> â†’ <b>Angajat</b>, apoi <b>Tip de activitate</b>,
          completeazÄƒ <b>Client</b> <i>(opÈ›ional pentru Comercial)</i> È™i (opÈ›ional) o <b>NotÄƒ</b>.
          Apoi foloseÈ™te butoanele de mai jos.
        </p>

        <div class="grid cols-3">
          <div>
            <label for="deptSelect">Departament</label>
            <select id="deptSelect"><option value="" selected disabled>Alege departamentul...</option></select>
          </div>

          <div>
            <label for="employeeSelect">Angajat</label>
            <select id="employeeSelect"><option>Se Ã®ncarcÄƒ...</option></select>
            <div class="status" id="empStatus"></div>
          </div>

          <div>
            <label for="activitySelect">Tip de activitate</label>
            <select id="activitySelect">
              <option value="" selected disabled>Alege tip...</option>
              <option>atelier</option>
              <option>birou-lucrare</option>
              <option>deplasare</option>
              <option>ofertare</option>
              <option>concediu de odihna</option>
              <option>concediu medical</option>
              <option>zi libera legala</option>
              <option>birou-administrativ</option>
              <option>home office</option>
              <option>invoire</option>
              <option>pe drum</option>
              <option>concediu pentru ore suplimentare</option>
              <option>birou + deplasare</option>
            </select>
          </div>

          <div>
            <label for="locationInput">Client</label>
            <input id="locationInput" type="text" placeholder="ex: È˜antier B â€“ PoartÄƒ 2" />
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          <div>
            <label for="notes">NotÄƒ (opÈ›ional)</label>
            <input id="notes" type="text" placeholder="ex: Proiect X, client Y" />
          </div>
        </div>

        <!-- Leave panel -->
        <div id="leavePanel" class="leave" style="display:none;margin-top:16px">
          <div class="kicker"><b>Cerere concediu</b> â€” adaugÄƒ <b>zile individuale</b> de concediu, apoi completeazÄƒ emailul personal È™i (opÈ›ional) o notÄƒ. Se trimite automat la HR.</div>

          <div class="grid cols-3" id="leaveDaysBlock">
            <div>
              <label for="leaveDay">Zi concediu</label>
              <input type="date" id="leaveDay" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button id="btnAddDay" class="btn extra" type="button" style="width:100%">AdaugÄƒ zi</button>
            </div>
            <div>
              <label>Zile selectate</label>
              <div id="leaveDaysList" class="status" style="min-height:44px"></div>
            </div>
          </div>
          <div class="grid cols-3">
            <div>
              <label for="leaveStart">Data start</label>
              <input type="date" id="leaveStart" />
            </div>
            <div>
              <label for="leaveEnd">Data sfÃ¢rÈ™it</label>
              <input type="date" id="leaveEnd" />
            </div>
            <div>
              <label for="leaveEmail">Email personal</label>
              <input type="email" id="leaveEmail" placeholder="ex: prenume.nume@..." />
            </div>
          </div>
          <div class="grid" style="margin-top:10px">
            <div>
              <label for="leaveNotes">NotÄƒ cÄƒtre HR (opÈ›ional)</label>
              <input type="text" id="leaveNotes" placeholder="ex: motiv / detalii" />
            </div>
          </div>
          <div class="btnbar">
            <button id="btnLeave" class="btn primary" type="button">Trimite cererea de concediu</button>
            <span class="status" id="leaveStatus"></span>
          </div>
        </div>

        <!-- Main + EXTRA action buttons (3 slot-uri: Start/Finish, Pause/Unpause, Extra Start/Extra Finish) -->
        <div class="btnbar" style="margin-top:16px">
          <div class="btn-slot">
            <button class="btn primary" id="btnStart"  type="button">Start</button>
            <button class="btn finish"  id="btnFinish" type="button" style="display:none">Finish</button>
          </div>
          <div class="btn-slot">
            <button class="btn pause"   id="btnPause"   type="button">Pause</button>
            <button class="btn unpause" id="btnUnpause" type="button" style="display:none">Unpause</button>
          </div>
          <div class="btn-slot" id="extraBar">
            <button class="btn extra" id="btnExtraStart"  type="button" title="PorneÈ™te orele extra (separate de suplimentare)">Extra Start</button>
            <button class="btn extra" id="btnExtraFinish" type="button" style="display:none" title="ÃŽncheie orele extra">Extra Finish</button>
          </div>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <div id="last" class="status mono" style="display:none"></div>
      </div>

      <aside class="card rail">
        <header style="display:flex;align-items:center;gap:10px;margin:4px 0 10px">
          <span class="dot" aria-hidden="true"></span>
          <h2 style="margin:0;font-size:18px">Scurt ghid</h2>
        </header>
        <div class="summary">
          <div class="item"><b>Start</b> porneÈ™te pontajul</div>
          <div class="item"><b>Pause</b> / <b>Unpause</b> marcheazÄƒ pauzele.</div>
          <div class="item"><b>Finish</b> Ã®ncheie ziua de lucru.</div>
          <div class="item"><b>Extra Start/Finish</b> â€” ore extra separate de suplimentare.</div>
          <div class="item"><b>Concedii</b> â€” alege tipul È™i trimite cererea.</div>
        </div>
        <div class="footer">Â© <span id="year"></span> SERVELECT. Toate drepturile rezervate.</div>
      </aside>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <iframe name="hidden_iframe" style="display:none;"></iframe>
  <iframe name="hidden_iframe_leave" style="display:none;"></iframe>

  <!-- Leave Google Form -->
  <form id="leaveForm" method="POST" target="hidden_iframe_leave" novalidate>
    <input type="hidden" id="lv_name" />
    <input type="hidden" id="lv_type" />
    <input type="hidden" id="lv_email" />
    <input type="hidden" id="lv_start" />
    <input type="hidden" id="lv_end" />
    <input type="hidden" id="lv_notes" />
    <input type="hidden" id="lv_ts" />
  </form>

  <!-- Main Google Form payload -->
  <form id="gform" method="POST" target="hidden_iframe" novalidate>
    <input type="hidden" id="f_action" />
    <input type="hidden" id="f_timestamp" />
    <input type="hidden" id="f_name" />
    <input type="hidden" id="f_activity" />
    <input type="hidden" id="f_location" />
    <input type="hidden" id="f_lat" />
    <input type="hidden" id="f_lon" />
    <input type="hidden" id="f_acc" />
    <input type="hidden" id="f_device" />
    <input type="hidden" id="f_notes" />
    <input type="hidden" id="f_maps" />
    <input type="hidden" id="f_department" />
    <input type="hidden" id="f_nonce" />
  </form>

  <!-- Fallback inline employees list -->
  <script type="text/plain" id="employees-inline">
Ion Popescu
Maria Ionescu
Vlad Georgescu
Ana Radu
  </script>

  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <!-- ================== SPLASH AUDIO & ANIM (RESYNCED) ================== -->
  <script>
/* ===== ServelectAudio â€” sincronizare strictÄƒ + pornire dupÄƒ user-gesture ===== */
const ServelectAudio = (() => {
  let ctx = null;
  const wait = (ms)=>new Promise(r=>setTimeout(r, ms));

  function ensureCtx(){
    if (ctx) return ctx;
    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return null;
    try { ctx = new AC(); } catch { ctx = null; }
    return ctx;
  }

  async function resumeIfSuspended(){
    const c = ensureCtx();
    if (!c) return false;
    if (c.state === 'running') return true;
    try { await c.resume(); } catch {}
    return c.state === 'running';
  }

  // AÈ™teaptÄƒ pÃ¢nÄƒ cÃ¢nd audio poate porni (gest utilizator) sau renunÈ›Äƒ dupÄƒ timeout
  async function waitUntilReady(timeout = 1200){
    const c = ensureCtx();
    if (!c) return false;
    if (c.state === 'running') return true;

    return new Promise((resolve)=>{
      let done = false;
      const finish = (ok)=>{ if (!done){ done = true; cleanup(); resolve(!!ok); } };
      const onUser = async ()=>{ if (await resumeIfSuspended()) finish(true); };
      const cleanup = ()=>{
        window.removeEventListener('pointerdown', onUser, opts);
        window.removeEventListener('keydown', onUser);
      };
      const opts = { once:true, passive:true };
      window.addEventListener('pointerdown', onUser, opts);
      window.addEventListener('keydown', onUser, { once:true });

      setTimeout(()=>finish(false), timeout);
    });
  }

  function playBeepAt(freq, dur=0.16, type='sine', gain=0.9, whenAbs=0){
    const c = ensureCtx(); if (!c || c.state !== 'running') return;
    const o = c.createOscillator();
    const g = c.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, whenAbs);
    g.gain.setValueAtTime(0.0001, whenAbs);
    g.gain.linearRampToValueAtTime(gain, whenAbs + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, whenAbs + dur);
    o.connect(g); g.connect(c.destination);
    try { o.start(whenAbs); o.stop(whenAbs + dur); } catch {}
  }

  function playSequence(events){
    const c = ensureCtx();
    // DacÄƒ audio nu e disponibil, Ã®ntoarcem o aÈ™teptare â€žmutÄƒâ€ pe durata totalÄƒ
    const totalSec = events.reduce((s,[,d=0.16,g=0.08])=>s + d + g, 0);
    if (!c || c.state !== 'running'){
      return wait(Math.round(totalSec * 1000) + 20);
    }
    const start = c.currentTime + 0.02; // mic offset pentru stabilitate
    let t = start;
    for (const e of events){
      const [f,d=0.16,gp=0.08,tp='sine',gn=0.9] = e;
      playBeepAt(f, d, tp, gn, t);
      t += d + gp;
    }
    return wait(Math.round((t - start) * 1000) + 20);
  }

  // Etapele de "Ã®ncÄƒrcare"
  function chargingStage(stage){
    if (stage === 1) return playSequence([[420, .18, 0.00, 'sine', 0.9]]);
    if (stage === 2) return playSequence([[620, .16, .08, 'sine', 0.9],[760, .18, 0.00, 'sine', 0.9]]);
    return playSequence([[780,.14,.06,'triangle',0.85],[900,.14,.06,'triangle',0.85],[1020,.16,0,'triangle',0.9]]);
  }
  function fullChime(){ return playSequence([[880,.22,.06,'triangle',0.9],[1108.7,.24,.06,'triangle',0.9],[1318.5,.28,0,'triangle',0.9]]); }

  return { ensureCtx, resumeIfSuspended, waitUntilReady, chargingStage, fullChime };
})();

/* ===== SPLASH timeline â€” UI sincronizat cu audio sau fallback silenÈ›ios cu aceiaÈ™i timpi ===== */
(function splashInit(){
  const splash = document.getElementById('splash');
  const battery  = document.getElementById('battery');
  const bars = [document.getElementById('bar1'),document.getElementById('bar2'),document.getElementById('bar3')];
  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));

  // Fallback durate (identice cu secvenÈ›ele audio): s1=180ms, s2=420ms, s3=560ms, chime=860ms
  const DUR = { s1:180, s2:420, s3:560, ch:860 };

  function resetBars(){ bars.forEach(b => b.className = 'bar'); battery.classList.remove('active'); }
  function stageToClasses(stage){
    resetBars();
    if (stage >= 1){ bars[0].classList.add('on','stage-red'); }
    if (stage >= 2){ bars[0].classList.remove('stage-red'); bars[0].classList.add('stage-yellow'); bars[1].classList.add('on','stage-yellow'); }
    if (stage >= 3){ bars.forEach(b => { b.classList.remove('stage-red','stage-yellow'); b.classList.add('on','stage-green'); }); battery.classList.add('active'); }
  }
  function hideSplash(){ splash.classList.add('hide'); }

  // Failsafe mai generos, sÄƒ nu taie chime-ul
  setTimeout(hideSplash, 4200);

  // ÃŽncepe timeline-ul doar dupÄƒ ce audio e gata, altfel ruleazÄƒ â€žmutâ€
  (async () => {
    resetBars();
    // IniÈ›ializeazÄƒ contextul; dacÄƒ user-ul nu a interacÈ›ionat, aÈ™teptÄƒm puÈ›in
    const audioReady = await ServelectAudio.waitUntilReady(1200);

    // Mic pre-roll vizual
    await wait(60);

    // Stage 1
    stageToClasses(1);
    if (audioReady) { await ServelectAudio.chargingStage(1); } else { await wait(DUR.s1); }

    // Stage 2
    stageToClasses(2);
    if (audioReady) { await ServelectAudio.chargingStage(2); } else { await wait(DUR.s2); }

    // Stage 3
    stageToClasses(3);
    if (audioReady) {
      await ServelectAudio.chargingStage(3);
      await ServelectAudio.fullChime();
    } else {
      await wait(DUR.s3 + DUR.ch);
    }

    hideSplash();
  })();

  // Reiau audio imediat la primul gest (Ã®n caz cÄƒ timeline-ul a pornit â€žmutâ€)
  window.addEventListener('pointerdown', () => ServelectAudio.resumeIfSuspended(), { once:true, passive:true });
  window.addEventListener('keydown', () => ServelectAudio.resumeIfSuspended(), { once:true });
  document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') ServelectAudio.resumeIfSuspended(); });
})();
  </script>

  <!-- ================== APP LOGIC (ANTI-SPAM pÄƒstrat) ================== -->
  <script>
/** ================== Helpers & Config ================== */
function setText(el, msg, cls){ el.className = (el.className.split(' ')[0] || 'status') + (cls?(' '+cls):''); el.textContent = msg; }
function _norm(s){ return String(s==null?'':s).trim(); }
function _normAction(a){
  let s = _norm(a).toLowerCase().replace(/[-\s]+/g,'_');
  if (s === 'resume') s='unpause';
  if (s === 'stop') s='finish';
  if (s === 'extra start') s='extra_start';
  if (s === 'extra finish') s='extra_finish';
  return s;
}
function showToast(msg, type){
  const t = document.getElementById('toast');
  t.className = 'toast' + (type ? ' ' + type : '');
  t.innerHTML = msg;
  t.style.display = 'block';
  clearTimeout(showToast._h);
  showToast._h = setTimeout(()=>{ t.style.display='none'; }, 7000);
}

/* NormalizÄƒri utile */
function normalizeName(s){
  return String(s||'')
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .toLowerCase()
    .trim();
}
function dayKeyLocal(iso){
  const d = new Date(iso);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}

/** Leave endpoint */
async function sendLeave(payload) {
  const cfg = window.CFG || {};
  if (!cfg.leaveEndpoint) {
    throw new Error('Endpoint concedii indisponibil Ã®n config.');
  }
  const r = await fetch(cfg.leaveEndpoint, {
    method: 'POST',
    headers: {'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(payload)
  });
  const txt = await r.text();
  let data; try { data = JSON.parse(txt); } catch { throw new Error('RÄƒspuns invalid: ' + txt.slice(0,200)); }
  if (!r.ok || !data.ok) throw new Error((data && data.error) || ('HTTP '+r.status));
  return data;
}

/* >>> ANTI-SPAM/LOCK utils */
const CLICK_COOLDOWN_MS = 1200;
const GUARD_MIN_LOCK_MS = 600;
let busy = false;
let lastActionAt = 0;
function setUILock(on){ document.body.classList.toggle('action-lock', !!on); }
function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }
function geolocateOnce(){
  return new Promise((resolve, reject) => {
    if (!('geolocation' in navigator)) return reject(new Error('GeolocaÈ›ie indisponibilÄƒ pe acest dispozitiv.'));
    navigator.geolocation.getCurrentPosition(
      pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: Math.round(pos.coords.accuracy || 0) }),
      err => reject(new Error('Eroare locaÈ›ie: ' + err.message)),
      { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
    );
  });
}
function randomNonce(){ return Math.random().toString(36).slice(2) + Date.now().toString(36); }

/* ============ READ Google Sheet (CSV / GViz) + calc pauze ============ */
function parseGvizDateStr(s){
  const m = /^Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),(\d+))?\)$/.exec(String(s).trim());
  if (!m) return null;
  const Y = +m[1], M = +m[2], D = +m[3], h = +(m[4]||0), mi = +(m[5]||0), se = +(m[6]||0);
  const d = new Date(Y, M, D, h, mi, se);
  return isNaN(d.getTime()) ? null : d.toISOString();
}
async function fetchGvizRows(url){
  const r = await fetch(url + (url.includes('?') ? '&' : '?') + 'tqx=out:json&rand=' + Date.now(), {cache:'no-store'});
  const txt = await r.text();
  const m = txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?/);
  if (!m) throw new Error('GViz format necunoscut');
  const data = JSON.parse(m[1]);
  if (!data.table || !data.table.rows) return [];
  const cols = data.table.cols.map(c => ({ label:(c.label||c.id||'').trim(), type:(c.type||'').trim() }));
  return data.table.rows.map(row => {
    const obj = {};
    row.c.forEach((cell, i) => {
      const label = cols[i].label || ('C'+i);
      const type  = cols[i].type;
      let v = (cell && 'v' in cell) ? cell.v : null;
      if (type === 'datetime' || type === 'date' || type === 'timeofday') {
        let iso = null;
        if (typeof v === 'string' && /^Date\(/.test(v)) iso = parseGvizDateStr(v);
        if (!iso && cell && typeof cell.f === 'string' && cell.f.trim()){
          const d = new Date(cell.f); if (!isNaN(d.getTime())) iso = d.toISOString();
        }
        v = iso || (typeof v === 'string' ? v : (cell && cell.f) || v);
      }
      obj[label] = v; obj[label.toLowerCase()] = v;
    });
    return obj;
  });
}
function parseCSV(text){
  if (text && text.charCodeAt && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
  text = (text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
  const lines = text.split('\n').filter(Boolean);
  if (!lines.length) return [];
  const sep = (text.indexOf(';') > -1 && text.indexOf(';') < text.indexOf(',')) ? ';' : ',';
  const hdr = lines[0].split(sep).map(s=>s.trim().replace(/^"|"$/g,''));
  return lines.slice(1).map(line=>{
    const cells = line.split(sep).map(s=>s.trim().replace(/^"|"$/g,''));
    const o = {};
    hdr.forEach((h,i)=>{ o[h]=cells[i]??''; o[h.toLowerCase()]=cells[i]??''; });
    return o;
  });
}
async function fetchCsvRows(url){
  const r = await fetch(url + (url.includes('?') ? '&' : '?') + 'rand=' + Date.now(), {cache:'no-store'});
  const txt = await r.text();
  return parseCSV(txt);
}
function isoFromAny(x){
  if (!x) return null;
  if (typeof x === 'string'){
    if (/^Date\(/.test(x)) return parseGvizDateStr(x);
    if (/^\d{4}-\d{2}-\d{2}T/.test(x)) return x;
    const d = new Date(x); if (!isNaN(d.getTime())) return d.toISOString();
    return null;
  }
  if (x && typeof x === 'object' && typeof x.getTime === 'function'){ return x.toISOString(); }
  return null;
}
function msBetween(isoA, isoB){ const a = new Date(isoA).getTime(); const b = new Date(isoB).getTime(); return Math.max(0, b - a); }
function closeIso(a, b, ms=120000){ return Math.abs(new Date(a).getTime() - new Date(b).getTime()) <= ms; }

async function getSheetEventsForDay(name, dayKeyLocalWanted, unpauseTsIso){
  const S = (window.CFG && window.CFG.sheet) || {};
  const cols = (S.cols || { timestamp:'f_timestamp', name:'f_name', action:'f_action' });

  let rows = [];
  if (S.gvizUrl){
    try {
      const raw = await fetchGvizRows(S.gvizUrl);
      rows = raw.map(r => {
        const ts = isoFromAny(r[cols.timestamp] ?? r['timestamp'] ?? r['Timestamp'] ?? r['data'] ?? r['datÄƒ'] ?? r['date']);
        const nm = String(r[cols.name] ?? r['name'] ?? r['Nume'] ?? r['nume'] ?? '').trim();
        const act = String(
          r[cols.action] ?? r['action'] ?? r['Actiune'] ?? r['AcÈ›iune'] ?? r['AcÅ£iune'] ?? r['actiune'] ?? r['acÈ›iune'] ?? r['acÅ£iune'] ?? ''
        ).trim();
        return { ts, name:nm, nameKey:normalizeName(nm), action:_normAction(act) };
      }).filter(x => x.ts);
    } catch(e){ rows = []; }
  }
  if (!rows.length && S.csvUrl){
    try {
      const raw = await fetchCsvRows(S.csvUrl);
      rows = raw.map(r => {
        const ts = isoFromAny(r[cols.timestamp] ?? r['timestamp'] ?? r['Timestamp'] ?? r['data'] ?? r['datÄƒ'] ?? r['date']);
        const nm = String(r[cols.name] ?? r['name'] ?? r['Nume'] ?? r['nume'] ?? '').trim();
        const act = String(
          r[cols.action] ?? r['action'] ?? r['Actiune'] ?? r['AcÈ›iune'] ?? r['AcÅ£iune'] ?? r['actiune'] ?? r['acÈ›iune'] ?? r['acÅ£iune'] ?? ''
        ).trim();
        return { ts, name:nm, nameKey:normalizeName(nm), action:_normAction(act) };
      }).filter(x => x.ts);
    } catch(e){ rows = []; }
  }

  if (!rows.length) return { events: [], hasCurrentUnpause:false };

  const target = normalizeName(name);
  const filtered = rows
    .filter(r =>
      r.nameKey === target &&
      dayKeyLocal(r.ts) === dayKeyLocalWanted &&
      (r.action==='pause' || r.action==='unpause'))
    .sort((a,b)=> new Date(a.ts) - new Date(b.ts));

  const hasCurrentUnpause = filtered.some(r => r.action==='unpause' && closeIso(r.ts, unpauseTsIso));
  return { events: filtered, hasCurrentUnpause };
}

function sumPausesFromEvents(events, fallbackPair){
  let totalMs = 0, curMs = 0, lastPause = null;
  for (const e of events){
    if (e.action === 'pause') {
      lastPause = e.ts;
    } else if (e.action === 'unpause' && lastPause){
      const seg = msBetween(lastPause, e.ts);
      totalMs += seg; curMs = seg; lastPause = null;
    }
  }
  if (lastPause && fallbackPair && fallbackPair.endIso){
    const seg = msBetween(lastPause, fallbackPair.endIso);
    totalMs += seg; curMs = seg;
  }
  return { totalMs, curMs };
}

/* ================== App logic ================== */
(function(){
  const statusEl = document.getElementById('status');
  const cfgEl = document.getElementById('cfg');
  const notesEl = document.getElementById('notes');
  const locInput = document.getElementById('locationInput');
  const deptSel = document.getElementById('deptSelect');
  const empSel = document.getElementById('employeeSelect');
  const actSel = document.getElementById('activitySelect');
  const empStatus = document.getElementById('empStatus');
  const form = document.getElementById('gform');

  const leavePanel = document.getElementById('leavePanel');
  const leaveStart = document.getElementById('leaveStart');
  const leaveEnd = document.getElementById('leaveEnd');
  const leaveEmail = document.getElementById('leaveEmail');
  const leaveNotes = document.getElementById('leaveNotes');
  const leaveStatus = document.getElementById('leaveStatus');
  const leaveDay = document.getElementById('leaveDay');
  const leaveDaysList = document.getElementById('leaveDaysList');
  const btnAddDay = document.getElementById('btnAddDay');
  const extraBar = document.getElementById('extraBar');
  let LEAVE_DAYS = [];

  function setStatus(m, c){ setText(statusEl, m, c); }
  function setCfg(m, c){
    if (!cfgEl) return;
    cfgEl.className = 'chip chip-menu' + (c ? (' ' + c) : '');
    const labelEl = document.getElementById('cfgLabel');
    if (labelEl) labelEl.textContent = m;
  }
  function setEmp(m, c){ setText(empStatus, m, c); }
  function setLeaveStatus(m, c){ setText(leaveStatus, m, c); }

  // >>> HARD GUARD pe click pentru toate .btn (capturÄƒ)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn');
    if (!btn) return;

    const now = Date.now();
    if (busy || (now - lastActionAt) < CLICK_COOLDOWN_MS) {
      e.stopImmediatePropagation();
      e.preventDefault();

      if (busy) {
        setStatus('Deja se proceseazÄƒ o acÈ›iune, te rog aÈ™teaptÄƒ cÃ¢teva secunde.', 'warn');
      } else {
        setStatus('Nu apÄƒsa butoanele atÃ¢t de repede ðŸ˜Š', 'warn');
      }
    }
  }, true);

  // ================= ADMIN HAMBURGER + LOGIN =================
  const cfgMenu = cfgEl;
  const cfgToggle = document.getElementById('cfgToggle');
  const cfgDropdown = document.getElementById('cfgDropdown');
  const adminLoginSection = document.getElementById('adminLoginSection');
  const adminLoggedSection = document.getElementById('adminLoggedSection');
  const adminLoginBtn = document.getElementById('adminLoginBtn');
  const adminLoginHint = document.getElementById('adminLoginHint');
  const adminUser = document.getElementById('adminUser');
  const adminPass = document.getElementById('adminPass');
  const adminNameSpan = document.getElementById('adminName');
  const goAdminBtn = document.getElementById('goAdminBtn');
  const adminLogoutBtn = document.getElementById('adminLogoutBtn');

  const ADMIN_LS_KEY = 'pontaj/admin/v1';
  let ADMIN_AUTH = null;
  let isAdminLogged = false;

  function getAdminSession(){
    try{
      const raw = localStorage.getItem(ADMIN_LS_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }
  function saveAdminSession(s){
    try{ localStorage.setItem(ADMIN_LS_KEY, JSON.stringify(s || {})); }catch{}
  }
  function clearAdminSession(){
    try{ localStorage.removeItem(ADMIN_LS_KEY); }catch{}
  }

  function setAdminHint(text, cls){
    if (!adminLoginHint) return;
    adminLoginHint.textContent = text || '';
    adminLoginHint.className = 'chip-hint' + (cls ? (' ' + cls) : '');
  }

  function updateAdminUiLoggedIn(label){
    isAdminLogged = true;
    if (adminLoginSection) adminLoginSection.hidden = true;
    if (adminLoggedSection) adminLoggedSection.hidden = false;
    if (adminNameSpan) adminNameSpan.textContent = label || 'Admin';
    setAdminHint('', '');
  }
  function updateAdminUiLoggedOut(){
    isAdminLogged = false;
    if (adminLoginSection) adminLoginSection.hidden = false;
    if (adminLoggedSection) adminLoggedSection.hidden = true;
    if (adminUser) adminUser.value = '';
    if (adminPass) adminPass.value = '';
    setAdminHint('', '');
  }

  function getAdminAuthUrl(){
    // ideal: setezi asta Ã®n config.json: "adminAuthUrl": "https://raw.githubusercontent.com/USER/REPO/branch/admin-auth.json"
    if (window.CFG && window.CFG.adminAuthUrl) return window.CFG.adminAuthUrl;
    // dacÄƒ laÈ™i gol, nu se va Ã®ncerca Ã®ncÄƒrcarea
    return '';
  }

  async function loadAdminConfig(){
    if (ADMIN_AUTH) return ADMIN_AUTH;
    const url = getAdminAuthUrl();
    if (!url) return null;
    try{
      const r = await fetch(url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now(), {cache:'no-store'});
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      if (data && (data.usernameHash || data.userHash)){
        ADMIN_AUTH = {
          usernameHash: data.usernameHash || data.userHash,
          passwordHash: data.passwordHash || data.passHash,
          label: data.label || 'Admin'
        };
        return ADMIN_AUTH;
      }
      throw new Error('StructurÄƒ admin-auth.json invalidÄƒ.');
    }catch(e){
      console.warn('Eroare admin-auth:', e);
      setAdminHint('Nu pot Ã®ncÄƒrca admin-auth.json din GitHub.', 'err');
      return null;
    }
  }

  async function sha256Hex(str){
    if (!window.crypto || !crypto.subtle) throw new Error('Browser prea vechi pentru crypto.');
    const enc = new TextEncoder();
    const data = enc.encode(str);
    const digest = await crypto.subtle.digest('SHA-256', data);
    const bytes = Array.from(new Uint8Array(digest));
    return bytes.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  async function verifyAdminCredentials(user, pass){
    if (!ADMIN_AUTH){
      await loadAdminConfig();
    }
    if (!ADMIN_AUTH || !ADMIN_AUTH.usernameHash || !ADMIN_AUTH.passwordHash){
      throw new Error('Config admin lipsÄƒ sau incomplet.');
    }
    const [uh, ph] = await Promise.all([sha256Hex(user), sha256Hex(pass)]);
    return (
      uh.toLowerCase() === ADMIN_AUTH.usernameHash.toLowerCase() &&
      ph.toLowerCase() === ADMIN_AUTH.passwordHash.toLowerCase()
    );
  }

  async function handleAdminLoginClick(){
    if (!adminUser || !adminPass) return;
    const u = adminUser.value.trim();
    const p = adminPass.value;
    if (!u || !p){
      setAdminHint('CompleteazÄƒ utilizatorul È™i parola.', 'warn');
      return;
    }
    if (adminLoginBtn){
      adminLoginBtn.disabled = true;
      adminLoginBtn.textContent = 'Se verificÄƒâ€¦';
    }
    setAdminHint('', '');
    try{
      const ok = await verifyAdminCredentials(u, p);
      if (!ok){
        setAdminHint('Date de logare greÈ™ite.', 'err');
        return;
      }
      const label = (ADMIN_AUTH && ADMIN_AUTH.label) || u;
      saveAdminSession({ user: label, at: new Date().toISOString() });
      updateAdminUiLoggedIn(label);
    }catch(e){
      setAdminHint('Eroare la verificare: ' + (e.message || e), 'err');
    }finally{
      if (adminLoginBtn){
        adminLoginBtn.disabled = false;
        adminLoginBtn.textContent = 'Autentificare';
      }
      if (adminPass) adminPass.value = '';
    }
  }

  function handleAdminLogout(){
    clearAdminSession();
    updateAdminUiLoggedOut();
  }

  function openCfgMenu(){
    if (!cfgMenu) return;
    cfgMenu.classList.add('open');
    if (cfgDropdown) cfgDropdown.setAttribute('aria-hidden', 'false');
  }
  function closeCfgMenu(){
    if (!cfgMenu) return;
    cfgMenu.classList.remove('open');
    if (cfgDropdown) cfgDropdown.setAttribute('aria-hidden', 'true');
  }
  function toggleCfgMenu(){
    if (!cfgMenu) return;
    if (cfgMenu.classList.contains('open')) closeCfgMenu();
    else openCfgMenu();
  }

  function setupAdminChipMenu(){
    if (!cfgMenu) return;

    const session = getAdminSession();
    if (session && session.user){
      updateAdminUiLoggedIn(session.user);
    }else{
      updateAdminUiLoggedOut();
    }

    if (cfgToggle){
      cfgToggle.addEventListener('click', (e)=>{
        e.stopPropagation();
        toggleCfgMenu();
      });
    }

    // click pe tot chip-ul
    cfgMenu.addEventListener('click', (e)=>{
      // dacÄƒ am apÄƒsat fix pe butonul de hamburger, Ã®l lÄƒsÄƒm pe handler-ul lui
      if (cfgToggle && (e.target === cfgToggle || cfgToggle.contains(e.target))) return;
      toggleCfgMenu();
    });

    // click Ã®n afara meniului => Ã®nchide
    document.addEventListener('click', (e)=>{
      if (!cfgMenu.classList.contains('open')) return;
      if (!cfgMenu.contains(e.target)) closeCfgMenu();
    });

    // ESC => Ã®nchide
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape' && cfgMenu.classList.contains('open')) closeCfgMenu();
    });

    if (adminLoginBtn){
      adminLoginBtn.addEventListener('click', handleAdminLoginClick);
    }
    if (adminPass){
      adminPass.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){
          e.preventDefault();
          handleAdminLoginClick();
        }
      });
    }
    if (goAdminBtn){
      goAdminBtn.addEventListener('click', ()=>{
        window.open('admin.html', '_blank');
      });
    }
    if (adminLogoutBtn){
      adminLogoutBtn.addEventListener('click', handleAdminLogout);
    }
  }


  let CFG = null;
  let STATE = blankState();
  const LS_KEY = 'pontaj/state/v1';

  function blankState(){
    return {
      name: '',
      normal: { running:false, paused:false },
      extra:  { running:false },
      lastNormalStart: null,
      lastNormalFinish: null,
      lastExtraStart: null,
      lastExtraFinish: null,
      lastPauseStart: null,
      pauseMsByDay: {}
    };
  }
  function loadLS(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch{return null;} }
  function saveLS(){ try { localStorage.setItem(LS_KEY, JSON.stringify(STATE)); } catch{} }

  function updateEmpStatus() {
    const selectedName = empSel.value;

    // Niciun angajat selectat
    if (!selectedName) {
      setEmp('', '');
      return;
    }

    // ÃŽncÄƒ nu avem state pentru acest angajat
    if (!STATE || !STATE.name || STATE.name !== selectedName) {
      setEmp('Se verificÄƒ starea angajatuluiâ€¦', '');
      return;
    }

    // Avem stare sincronizatÄƒ pentru angajatul selectat
    if (STATE.normal.running && STATE.normal.paused) {
      setEmp('Stare curentÄƒ: PAUZÄ‚ (normÄƒ).', 'warn');
    } else if (STATE.normal.running) {
      setEmp('Stare curentÄƒ: LUCREZI (normÄƒ).', 'ok');
    } else if (STATE.extra.running) {
      setEmp('Stare curentÄƒ: LUCREZI (EXTRA).', 'ok');
    } else {
      setEmp('Stare curentÄƒ: niciun pontaj activ.', '');
    }
  }

  function bindCFGToForm() {
    if (!(CFG && CFG.formAction && CFG.fields)) return false;
    form.action = CFG.formAction;
    const names = CFG.fields;
    const idMap = {
      'f_action':   names.action,
      'f_timestamp':names.timestamp,
      'f_name':     names.name,
      'f_activity': names.activityType,
      'f_location': names.location,
      'f_lat':      names.latitude,
      'f_lon':      names.longitude,
      'f_acc':      names.accuracy,
      'f_device':   names.device,
      'f_notes':    names.notes,
      'f_maps':     names.mapsLink,
      'f_department': names.department || ''
    };
    Object.entries(idMap).forEach(([id,name]) => {
      const el = document.getElementById(id);
      if (el && name) el.setAttribute('name', name);
    });
    return true;
  }

  function bindLeaveForm() {
    if (!(CFG && CFG.leaveFormAction && CFG.leaveFields)) return false;
    const m = CFG.leaveFields;
    const map = {
      'lv_name':  m.name,
      'lv_type':  m.activityType,
      'lv_email': m.personalEmail,
      'lv_start': m.startDate,
      'lv_end':   m.endDate,
      'lv_notes': m.notes,
      'lv_ts':    m.timestamp
    };
    Object.entries(map).forEach(([id, name]) => {
      const el = document.getElementById(id);
      if (el && name) el.setAttribute('name', name);
    });
    document.getElementById('leaveForm').action = CFG.leaveFormAction;
    return true;
  }

  /** ===== EMPLOYAÈšI & DEPARTAMENTE ===== */

  function parseEmployeesCSV(text){
    if (text && text.charCodeAt && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    text = (text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
    if (!text) return [];
    if (!/,|;/.test(text)) return text.split('\n').map(s => s.trim()).filter(Boolean);
    const comma = (text.match(/,/g) || []).length;
    const semiCount = (text.match(/;/g) || []).length;
    const delim = semiCount > comma ? ';' : ',';
    const rows = text.split('\n').map(line => line.split(delim).map(c => c.trim().replace(/^"|"$/g,''))).filter(r => r.length && r.join('').length);
    const header = rows[0].map(h => (h||'').toLowerCase());
    let startIdx = 0, nameCol = 0;
    if (header.some(h => /angajat|nume|employee|name/.test(h))) {
      nameCol = Math.max(0, header.findIndex(h => /angajat|nume|employee|name/.test(h)));
      startIdx = 1;
    }
    const list = [];
    for (let i=startIdx;i<rows.length;i++){
      const v = (rows[i][nameCol] || '').trim();
      if (v) list.push(v);
    }
    return list;
  }
  function getInlineEmployees(){
    const el = document.getElementById('employees-inline');
    if (!el) return [];
    return el.textContent.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  }

  function parseDepartmentsCSV(text){
    if (text && text.charCodeAt && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    text = (text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
    if (!text) return { byDept:new Map(), byName:new Map(), deptList:[] };

    const lines = text.split('\n').filter(Boolean);
    const sep = (text.indexOf(';') > -1 && (text.indexOf(';') < text.indexOf(','))) ? ';' : ',';

    let start = 0, depCol = 0, nameCol = 1;
    const hdr = lines[0].split(sep).map(s=>s.trim().replace(/^"|"$/g,'').toLowerCase());
    if (hdr.some(h => /depart|dept/.test(h)) || hdr.some(h => /angajat|nume|employee|name/.test(h))) {
      const d = hdr.findIndex(h => /depart|dept/.test(h));
      const n = hdr.findIndex(h => /angajat|nume|employee|name/.test(h));
      if (d >= 0) depCol = d;
      if (n >= 0) nameCol = n;
      start = 1;
    }

    const byDept = new Map();
    const byName = new Map();

    for (let i=start;i<lines.length;i++){
      const cells = lines[i].split(sep).map(s=>s.trim().replace(/^"|"$/g,''));
      const dep = (cells[depCol]||'').trim();
      const nm  = (cells[nameCol]||'').trim();
      if (!dep || !nm) continue;
      if (!byDept.has(dep)) byDept.set(dep, []);
      byDept.get(dep).push(nm);
      byName.set(nm, dep);
    }

    const deptList = Array.from(byDept.keys()).sort((a,b)=>a.localeCompare(b,'ro'));
    for (const d of byDept.keys()) byDept.get(d).sort((a,b)=>a.localeCompare(b,'ro'));
    return { byDept, byName, deptList };
  }

  let DEPTMAP = { byDept:new Map(), byName:new Map(), deptList:[] };

  function fillDepartments(deptList){
    deptSel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value=''; ph.textContent='Alege departamentul...'; ph.disabled = true; ph.selected = true;
    deptSel.appendChild(ph);
    deptList.forEach(d => { const o=document.createElement('option'); o.value=d; o.textContent=d; deptSel.appendChild(o); });
  }

  function fillEmployeesFromDept(dept){
    const sel = empSel;
    sel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value=''; ph.textContent= dept ? 'Alege angajatâ€¦' : 'Alege departamentul mai Ã®ntÃ¢iâ€¦';
    ph.disabled = true; ph.selected = true;
    sel.appendChild(ph);
    if (!dept) return;
    const list = (DEPTMAP.byDept.get(dept) || []);
    list.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  }

  async function loadDepartments(){
    try{
      if (window.CFG && window.CFG.departmentsCsv){
        const url = window.CFG.departmentsCsv + (window.CFG.departmentsCsv.includes('?') ? '&' : '?') + 'v=' + Date.now();
        const r = await fetch(url, {cache:'no-store'});
        if (r.ok){
          const txt = await r.text();
          const map = parseDepartmentsCSV(txt);
          if (map.deptList.length){
            DEPTMAP = map;
            fillDepartments(map.deptList);
            setStatus('Departamente Ã®ncÄƒrcate din departmentsCsv.', 'ok');
            return;
          }
        }
      }
    }catch(e){}

    // Fallback
    let fallbackEmployees = [];
    try {
      if (window.CFG && window.CFG.employeesCsv){
        const url = window.CFG.employeesCsv + (window.CFG.employeesCsv.includes('?') ? '&' : '?') + 'v=' + Date.now();
        const r = await fetch(url, {cache:'no-store'});
        if (r.ok) fallbackEmployees = parseEmployeesCSV(await r.text());
      }
    } catch(e){}
    if (!fallbackEmployees.length && window.CFG && Array.isArray(window.CFG.employees)) fallbackEmployees = window.CFG.employees.slice();
    if (!fallbackEmployees.length) fallbackEmployees = getInlineEmployees();

    const byDept = new Map([['productie', fallbackEmployees]]);
    const byName = new Map(fallbackEmployees.map(nm => [nm, 'productie']));
    const deptList = ['productie'];
    DEPTMAP = { byDept, byName, deptList };
    fillDepartments(deptList);
    setStatus('Nu existÄƒ departmentsCsv â€” folosesc â€žproductieâ€.', 'warn');
  }

  /** ===== STATE (UI + server) ===== */
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnUnpause = document.getElementById('btnUnpause');
  const btnFinish = document.getElementById('btnFinish');
  const btnExtraStart = document.getElementById('btnExtraStart');
  const btnExtraFinish = document.getElementById('btnExtraFinish');

  function reflectState(){
    if (!btnStart) return;
    const running = !!STATE.normal.running;
    const paused  = !!STATE.normal.paused;
    const extraR  = !!STATE.extra.running;
    const hasSel  = !!empSel.value;

    // implicit: Start / Pause / Extra Start vizibile
    btnStart.style.display       = '';
    btnFinish.style.display      = 'none';
    btnPause.style.display       = '';
    btnUnpause.style.display     = 'none';
    btnExtraStart.style.display  = '';
    btnExtraFinish.style.display = 'none';

    // Slot Start/Finish
    if (running){
      btnStart.style.display  = 'none';
      btnFinish.style.display = '';
    }

    // Slot Pause/Unpause
    if (running && paused){
      btnPause.style.display   = 'none';
      btnUnpause.style.display = '';
    }

    // Slot Extra Start/Finish
    if (extraR){
      btnExtraStart.style.display  = 'none';
      btnExtraFinish.style.display = '';
    }

    // Disabled logic (È›inÃ¢nd cont de stare)
    btnStart.disabled       = !hasSel || running || extraR;
    btnFinish.disabled      = !hasSel || !running || paused;
    btnPause.disabled       = !hasSel || !running || paused;
    btnUnpause.disabled     = !hasSel || !running || !paused;
    btnExtraStart.disabled  = !hasSel || running || extraR;
    btnExtraFinish.disabled = !hasSel || !extraR;
  }
  function disableTimeButtons(disabled) {
    [btnStart,btnPause,btnUnpause,btnFinish,btnExtraStart,btnExtraFinish].forEach(el=>{
      if (el) el.disabled = !!disabled;
    });
  }
  function disableAllButtons(disabled){
    disableTimeButtons(disabled);
    const lbtn = document.getElementById('btnLeave');
    if (lbtn) lbtn.disabled = !!disabled;
  }

  // ==== STATE & STATS API HELPERS ====
  function baseEndpoint(){
    const fromCfg = (window.CFG && (CFG.guardEndpoint || CFG.stateEndpoint)) || '';
    const base = (fromCfg || location.href).replace(/\?.*$/,'');
    return base;
  }
  async function fetchState(name){
    const url = baseEndpoint() + '?fn=state&name=' + encodeURIComponent(name);
    try{
      const r = await fetch(url, { cache:'no-store' });
      const txt = await r.text();
      return JSON.parse(txt).state || null;
    }catch{ return null; }
  }
  async function fetchStats(name){
    const url = baseEndpoint() + '?fn=stats&name=' + encodeURIComponent(name);
    try{
      const r = await fetch(url, { cache:'no-store' });
      const txt = await r.text();
      const data = JSON.parse(txt);
      return (data && data.ok) ? data.stats : null;
    }catch{ return null; }
  }
  async function fetchPauseTotals(name, untilIso){
    const url = baseEndpoint() + '?fn=pausetotals&name=' + encodeURIComponent(name) + (untilIso ? ('&until=' + encodeURIComponent(untilIso)) : '');
    try{
      const r = await fetch(url, { cache:'no-store' });
      const txt = await r.text();
      const data = JSON.parse(txt);
      return (data && data.ok) ? data : null;
    }catch{ return null; }
  }
  async function guardRemote(name, action){
    const url = baseEndpoint() + '?fn=guard';
    try{
      const r = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({ name, action: _normAction(action) })
      });
      const txt = await r.text();
      let data; try { data = JSON.parse(txt); } catch { return {ok:true}; }
      return data;
    }catch{
      return {ok:true};
    }
  }

  const minutesFromMs = (ms)=> Math.round(ms / 60000);
// ===== FORMAT helpers (ore zecimale -> h + m) =====
function fmtHoursToHM(val){
  const raw = String(val ?? '').trim();
  if (!raw) return '';

  // dacÄƒ deja e HH:MM sau conÈ›ine "h", Ã®l lÄƒsÄƒm aÈ™a
  if (/^\d{1,3}:\d{2}$/.test(raw) || /\bh\b/i.test(raw)) return raw;

  // acceptÄƒ È™i virgulÄƒ: "7,5"
  const num = parseFloat(raw.replace(',', '.').replace(/[^0-9.]+/g, ''));
  if (!isFinite(num)) return raw;

  const totalMin = Math.max(0, Math.round(num * 60));
  const h = Math.floor(totalMin / 60);
  const m = totalMin % 60;
  return `${h}h ${String(m).padStart(2,'0')}m`;
}

function fmtMinToHM(min){
  const mm = Math.max(0, Math.round(Number(min) || 0));
  const h = Math.floor(mm / 60);
  const m = mm % 60;
  return `${h}h ${String(m).padStart(2,'0')}m`;
}

  function applyLocalTransition(action, ts){
    action = _normAction(action);
    switch(action){
      case 'start':
        STATE.normal.running = true;
        STATE.normal.paused  = false;
        STATE.lastNormalStart = ts;
        break;
      case 'pause':
        STATE.normal.paused = true;
        STATE.lastPauseStart = ts;
        break;
      case 'unpause': {
        STATE.normal.paused = false;
        if (STATE.lastPauseStart){
          const start = STATE.lastPauseStart;
          const end = ts;
          const ms = Math.max(0, new Date(end) - new Date(start));
          const key = dayKeyLocal(start);
          STATE.pauseMsByDay[key] = (STATE.pauseMsByDay[key]||0) + ms;
          STATE.lastPauseStart = null;
        }
        break;
      }
      case 'finish':
        STATE.normal.running = false;
        STATE.normal.paused  = false;
        STATE.lastNormalFinish = ts;
        break;
      case 'extra_start':
        STATE.extra.running = true;
        STATE.lastExtraStart = ts;
        break;
      case 'extra_finish':
        STATE.extra.running = false;
        STATE.lastExtraFinish = ts;
        break;
    }
  }

  function setFormPayload(action, ts, gps){
    document.getElementById('f_action').value    = _normAction(action);
    document.getElementById('f_timestamp').value = ts;
    document.getElementById('f_name').value      = empSel.value;
    document.getElementById('f_activity').value  = actSel.value;
    document.getElementById('f_location').value  = (locInput.value||'').trim();
    document.getElementById('f_lat').value       = gps.lat;
    document.getElementById('f_lon').value       = gps.lon;
    document.getElementById('f_acc').value       = gps.acc;
    document.getElementById('f_device').value    = navigator.userAgent;
    document.getElementById('f_notes').value     = (notesEl.value || '');
    document.getElementById('f_maps').value      = `https://maps.google.com/?q=${gps.lat},${gps.lon}`;
    const deptFromMap = (DEPTMAP.byName && DEPTMAP.byName.get) ? (DEPTMAP.byName.get(empSel.value) || '') : '';
    document.getElementById('f_department').value = (deptSel.value || deptFromMap || '');
    document.getElementById('f_nonce').value      = randomNonce();
  }

  async function refreshServerState(){ 
    if (!STATE.name) return;
    try {
      const keepPauseFields = {
        lastPauseStart: STATE.lastPauseStart,
        pauseMsByDay: Object.assign({}, STATE.pauseMsByDay)
      };
      const remote = await fetchState(STATE.name);
      if (remote) {
        STATE = Object.assign(blankState(), keepPauseFields, remote);
        STATE.name = empSel.value || STATE.name || '';
        saveLS();
      }
      updateEmpStatus();
    } catch(e){}
  }

  async function handleEmployeeChange(){
    STATE = blankState();
    STATE.name = empSel.value || '';
    saveLS();

    setEmp('Se verificÄƒ starea angajatuluiâ€¦', '');
    await refreshServerState();
    reflectState();
    updateEmpStatus();
  }

  function isComercialDept(){
    const v = (deptSel.value || '').toLowerCase();
    return v === 'comercial' || v === 'coemercial';
  }

  async function computePauseFromSheetAndShow(name, untilIso){
    let totMin = 0, curMin = 0;

    try{
      const s = await fetchPauseTotals(name, untilIso);
      if (s && s.ok){
        totMin = Number(s.totalMin) || 0;
        curMin = Number(s.curMin)   || 0;
      }
    }catch{}

    if (!totMin && !curMin){
      try{
        const keyLocal = dayKeyLocal(untilIso);
        const r = await getSheetEventsForDay(name, keyLocal, untilIso);
        const sums = sumPausesFromEvents(r.events, { endIso: untilIso });
        totMin = Math.round(sums.totalMs/60000);
        curMin = Math.round(sums.curMs/60000);
      }catch{}
    }

 setStatus(
  `PauzÄƒ Ã®ncheiatÄƒ â€” interval curent: ${fmtMinToHM(curMin)} â€¢ total azi: ${fmtMinToHM(totMin)}.`,
  'ok'
);

showToast(
  `<b>PauzÄƒ Ã®ncheiatÄƒ</b><div class="small">Curent: <b>${fmtMinToHM(curMin)}</b> â€¢ Total azi: <b>${fmtMinToHM(totMin)}</b></div>`,
  'ok'
);

  }

  // ==================== ACTION SUBMIT cu LOCK ANTISPAM IMEDIAT ====================
  async function submitAction(action) {
    const now = Date.now();
    if (busy) {
      setStatus('Deja se proceseazÄƒ o acÈ›iune, te rog aÈ™teaptÄƒ cÃ¢teva secunde.', 'warn');
      return;
    }
    if (now - lastActionAt < CLICK_COOLDOWN_MS) {
      setStatus('Nu apÄƒsa butoanele atÃ¢t de repede ðŸ˜Š', 'warn');
      return;
    }

    if (!deptSel.value) { setStatus('Alege departamentul.', 'err'); return; }
    if (!empSel.value)  { setStatus('SelecteazÄƒ angajat.', 'err'); return; }
    if (!actSel.value)  { setStatus('Alege tip de activitate.', 'err'); return; }

    const actNorm = _normAction(action);
    const isCom = isComercialDept();

    if (isCom && (actNorm === 'extra_start' || actNorm === 'extra_finish')) {
      setStatus('Departamentul Comercial nu poate folosi ore EXTRA.', 'warn');
      return;
    }
    if (!isCom && !locInput.value.trim()) {
      setStatus('Scrie clientul/locaÈ›ia.', 'err');
      locInput.focus();
      return;
    }
    if (['concediu de odihna','concediu medical','concediu pentru ore suplimentare'].includes((actSel.value||'').toLowerCase())){
      setStatus('Pentru concediu foloseÈ™te â€žTrimite cererea de concediuâ€.', 'warn');
      return;
    }

    busy = true;
    setUILock(true);
    disableAllButtons(true);
    const lockStart = Date.now();

    try {
      setStatus('Sincronizez stareaâ€¦', '');
      await refreshServerState();
      reflectState();

      {
        const running = STATE.normal.running;
        const paused  = STATE.normal.paused;
        const extraR  = STATE.extra.running;
        const e = (()=>{
          switch(actNorm){
            case 'start':        if (running) return 'Ai deja START activ.'; if (extraR) return 'FinalizeazÄƒ â€žEXTRAâ€ Ã®nainte de START.'; break;
            case 'pause':        if (!running) return 'Nu poÈ›i PAUSE fÄƒrÄƒ START.'; if (paused) return 'EÈ™ti deja Ã®n PAUSE.'; break;
            case 'unpause':      if (!running) return 'Nu poÈ›i UNPAUSE fÄƒrÄƒ START.'; if (!paused) return 'Nu eÈ™ti Ã®n PAUSE.'; break;
            case 'finish':       if (!running) return 'Nu poÈ›i FINISH fÄƒrÄƒ START.'; if (paused) return 'Nu poÈ›i FINISH Ã®n PAUSE â€” apasÄƒ UNPAUSE mai Ã®ntÃ¢i.'; break;
            case 'extra_start':  if (running) return 'ÃŽnchide norma (FINISH) Ã®nainte de EXTRA START.'; if (extraR) return 'EXTRA este deja pornit.'; break;
            case 'extra_finish': if (!extraR) return 'Nu poÈ›i EXTRA FINISH fÄƒrÄƒ EXTRA START.'; break;
          }
          return null;
        })();
        if (e) { setStatus(e, 'warn'); return; }
      }

      setStatus('Verific reguliâ€¦', '');
      const g = await guardRemote(empSel.value.trim(), action);
      if (!g.ok) { setStatus(g.msg || 'AcÈ›iune blocatÄƒ de regulile de pontaj.', 'warn'); return; }

      setStatus('Se obÈ›ine locaÈ›ia GPSâ€¦', '');
      const gps = await geolocateOnce();

      const ts = new Date().toISOString();
      setFormPayload(action, ts, gps);

      if (form.action && form.action.trim().length && form.querySelector('[name]')) {
        form.submit();
      } else {
        setStatus('AtenÈ›ie: nu existÄƒ config de formular â€” acÈ›iunea se Ã®nregistreazÄƒ doar local/UI.', 'warn');
      }

      applyLocalTransition(action, ts);
      saveLS();
      reflectState();
      updateEmpStatus();

      if (actNorm === 'unpause'){
        try{
          await computePauseFromSheetAndShow(empSel.value.trim(), ts);
        } catch(e){
          setStatus(`UNPAUSE trimis âœ“ (nu am putut calcula pauza din server/foaie)`, 'warn');
        }
      } else {
        setStatus(`Trimis âœ“ (${actNorm.toUpperCase()}).`, 'ok');
      }

      await sleep(1200);
      await refreshServerState();
      reflectState();

      try {
        const stats = await fetchStats(empSel.value.trim());
        if (stats){
       if (actNorm === 'finish'){
  const ore = fmtHoursToHM(stats.totalHours);
  const supl = fmtHoursToHM(stats.overtime);

  setStatus(`Finish âœ“ â€” Azi: ${ore} â€¢ Suplimentar: ${supl}.`, 'ok');
  showToast(
    `<b>${empSel.value}</b><div class="small">Azi â€” Ore: <b>${ore}</b> â€¢ Suplimentar: <b>${supl}</b></div>`,
    'ok'
  );

} else if (actNorm === 'extra_finish'){
  const extra = fmtHoursToHM(stats.extra);

  setStatus(`Extra Finish âœ“ â€” Azi: Extra: ${extra}.`, 'ok');
  showToast(
    `<b>${empSel.value}</b><div class="small">Azi â€” Extra: <b>${extra}</b></div>`,
    'ok'
  );
}

        }
      } catch {}
    } catch (err) {
      setStatus(String(err && err.message ? err.message : err), 'err');
    } finally {
      const elapsed = Date.now() - lockStart;
      if (elapsed < GUARD_MIN_LOCK_MS) await sleep(GUARD_MIN_LOCK_MS - elapsed);
      lastActionAt = Date.now();
      await sleep(CLICK_COOLDOWN_MS);
      busy = false;
      setUILock(false);
      disableAllButtons(false);
      reflectState();
      updateEmpStatus();
    }
  }

  function wireButtons(){
    document.getElementById('btnStart').addEventListener('click', ()=>submitAction('start'));
    document.getElementById('btnPause').addEventListener('click', ()=>submitAction('pause'));
    document.getElementById('btnUnpause').addEventListener('click', ()=>submitAction('unpause'));
    document.getElementById('btnFinish').addEventListener('click', ()=>submitAction('finish'));
    document.getElementById('btnExtraStart').addEventListener('click', ()=>submitAction('extra_start'));
    document.getElementById('btnExtraFinish').addEventListener('click', ()=>submitAction('extra_finish'));

    ['btnStart','btnPause','btnUnpause','btnFinish','btnExtraStart','btnExtraFinish','btnLeave']
      .forEach(id=>{
        const b = document.getElementById(id);
        if (!b) return;
        b.addEventListener('keydown', (e)=>{ if (e.repeat) e.preventDefault(); });
      });

    reflectState();
  }

  /** ===== INIT ===== */
  (async function init(){
    try {
      const r = await fetch('config.json?v=' + Date.now(), {cache:'no-store'});
      if (!r.ok) throw new Error('HTTP ' + r.status);
      CFG = await r.json();
      if (!CFG || !CFG.fields) throw new Error('Config incomplet');
      setCfg('Config Ã®ncÄƒrcat', 'ok');
      window.CFG = CFG;
    } catch (e) {
      setCfg('Eroare config â€” rulez fallback local.', 'warn');
      window.CFG = {};
    }

    bindCFGToForm();
    bindLeaveForm();

    await loadDepartments();
    fillEmployeesFromDept('');

    const cached = loadLS();
    if (cached) STATE = Object.assign(blankState(), cached);

    if (STATE.name && DEPTMAP.byName && DEPTMAP.byName.has(STATE.name)){
      const d = DEPTMAP.byName.get(STATE.name);
      if (d){
        deptSel.value = d;
        fillEmployeesFromDept(d);
        empSel.value = STATE.name;
        if (extraBar) extraBar.style.display = isComercialDept() ? 'none' : '';
        await handleEmployeeChange();
      }
    }

    deptSel.addEventListener('change', () => {
      fillEmployeesFromDept(deptSel.value);
      if (empSel.value && (DEPTMAP.byName.get(empSel.value) !== deptSel.value)) {
        empSel.value = '';
      }
      if (extraBar) extraBar.style.display = isComercialDept() ? 'none' : '';
      STATE = blankState(); STATE.name = '';
      reflectState(); setEmp('', '');
    });

    if (extraBar) extraBar.style.display = '';

    empSel.addEventListener('change', handleEmployeeChange);

    const LEAVE_TYPES = new Set(['concediu de odihna','concediu medical','concediu pentru ore suplimentare']);
    actSel.addEventListener('change', () => {
      const isLeave = LEAVE_TYPES.has((actSel.value||'').toLowerCase());
      leavePanel.style.display = isLeave ? '' : 'none';
      disableTimeButtons(isLeave);
      if (isLeave) { LEAVE_DAYS = []; setLeaveStatus('', ''); }
    });

    if (btnAddDay && leaveDaysList && leaveDay){
      btnAddDay.addEventListener('click', () => {
        const v = (leaveDay.value||'').trim();
        if (!v) return;
        if (!LEAVE_DAYS.includes(v)) LEAVE_DAYS.push(v);
        LEAVE_DAYS.sort();
        leaveDaysList.textContent = LEAVE_DAYS.join(', ');
      });
    }

    wireButtons();

    document.getElementById('btnLeave').addEventListener('click', async () => {
      setLeaveStatus('', '');
      if (!deptSel.value) { setLeaveStatus('Alege departamentul.', 'err'); return; }
      if (!empSel.value)  { setLeaveStatus('SelecteazÄƒ angajat.', 'err'); return; }
      const tip = (actSel.value || '').toLowerCase();
      const LEAVES = new Set(['concediu de odihna','concediu medical','concediu pentru ore suplimentare']);
      if (!LEAVES.has(tip)) { setLeaveStatus('Alege un tip de concediu.', 'err'); return; }
      const sd = leaveStart.value;
      const ed = leaveEnd.value;
      const hasDays = Array.isArray(LEAVE_DAYS) && LEAVE_DAYS.length > 0;
      if (!hasDays) {
        if (!sd || !ed) { setLeaveStatus('AdaugÄƒ cel puÈ›in o zi de concediu sau completeazÄƒ intervalul (startâ€“sfÃ¢rÈ™it).', 'err'); return; }
        if (ed < sd) { setLeaveStatus('Data de sfÃ¢rÈ™it nu poate fi Ã®nainte de start.', 'err'); return; }
      }
      const email = (leaveEmail.value || '').trim();
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setLeaveStatus('Email personal invalid.', 'err'); return; }

      setLeaveStatus('Se trimite cerereaâ€¦', '');

      let formSubmitted = false;
      if (window.CFG && window.CFG.leaveFormAction && window.CFG.leaveFields) {
        try {
          document.getElementById('lv_name').value  = empSel.value;
          document.getElementById('lv_type').value  = tip;
          document.getElementById('lv_email').value = email;
          const _daysSorted = hasDays ? LEAVE_DAYS.slice().sort() : [];
          const _first = hasDays ? _daysSorted[0] : sd;
          const _last  = hasDays ? _daysSorted[_daysSorted.length-1] : ed;
          document.getElementById('lv_start').value = _first;
          document.getElementById('lv_end').value   = _last;
          document.getElementById('lv_notes').value = (leaveNotes.value || '');
          document.getElementById('lv_ts').value    = new Date().toISOString();
          document.getElementById('leaveForm').submit();
          formSubmitted = true;
        } catch (e) { console.warn('Leave Form submit failed', e); }
      }

      let endpointOk = false, endpointMsg = '';
      if (window.CFG && window.CFG.leaveEndpoint) {
        try {
          const _daysSorted = hasDays ? LEAVE_DAYS.slice().sort() : [];
          const _first = hasDays ? _daysSorted[0] : sd;
          const _last  = hasDays ? _daysSorted[_daysSorted.length-1] : ed;
          const payload = {
            name: empSel.value,
            activityType: tip,
            startDate: _first,
            endDate: _last,
            days: hasDays ? _daysSorted : undefined,
            personalEmail: email,
            notes: (leaveNotes.value || '')
          };
          const res = await sendLeave(payload);
          endpointOk = true;
          endpointMsg = ' (Ã®nregistratÄƒ ' + res.zile + ' zile)';
        } catch (err) { console.warn('Leave endpoint error:', err); }
      }

      if (formSubmitted || endpointOk) {
        setLeaveStatus('Cerere trimisÄƒ' + endpointMsg + '. HR a fost notificat.', 'ok');
        LEAVE_DAYS = [];
        leaveDaysList.textContent = '';
      } else {
        setLeaveStatus('Eroare: nu s-a putut trimite cererea (Form/Endpoint).', 'err');
      }
    });
    setupAdminChipMenu();

  })();

})(); // IIFE
  </script>
</body>
