<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SERVELECT • Pontaj & Concedii</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon.png" />
  <meta name="theme-color" content="#516A75"/>
  <style>
    :root{
      --brand: rgba(81,106,117,0.88);
      --brand-dark:#2f3e45;
      --accent: rgba(149,202,75,0.91);
      --text:#0f172a;
      --muted:#5b6b73;
      --bg:#f4f7f9;
      --card:#ffffff;
      --ring:#cfe0e7;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%; width:100%}
    body{
      margin:0;
      font-family: Montserrat, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        linear-gradient(180deg, rgba(149, 202, 75, 0.91) 0%, rgba(81, 106, 117, 0.88) 66%),
        url('background.jpg');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      min-height:100vh;
    }
    .shell{max-width:1100px;margin:0 auto;padding:24px;}
    .nav{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;padding:14px 16px;border-radius:16px;
      background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.80));
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 30px rgba(81,106,117,.18);
      border:1px solid rgba(81,106,117,.18);
    }
    .brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
    .brand img{ width:38px;height:38px;object-fit:contain;aspect-ratio:1/1;border-radius:10px;box-shadow:0 3px 10px rgba(81,106,117,.25) }
    .brand h1{font-size:18px;letter-spacing:.2px;margin:0;line-height:1.1}
    .brand h1 span{display:block;font-weight:700}
    .brand small{display:block;font-size:12px;color:var(--muted);margin-top:2px}
    .hero{ margin-top:20px; display:grid;grid-template-columns:1.1fr .9fr;gap:24px;align-items:stretch; }
    @media (max-width:900px){ .hero{grid-template-columns:1fr} }
    .card{ background:var(--card); border:1px solid rgba(14,165,233,.12); border-radius:18px; box-shadow: 0 20px 60px rgba(2,132,199,.08); }
    .panel{padding:20px 20px 14px 20px}
    .panel header{ display:flex;align-items:center;gap:10px;margin:6px 0 14px; }
    .panel header .dot{ width:10px;height:10px;border-radius:50%;background:var(--accent); box-shadow:0 0 0 4px rgba(149,202,75,0.18); }
    .panel header h2{margin:0;font-size:18px}
    .sub{color:var(--muted);font-size:14px;margin:0 0 14px}
    label{display:block;font-size:12px;color:var(--muted);margin:4px 0 6px}
    .grid{display:grid;gap:14px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:900px){ .grid.cols-3,.grid.cols-2{grid-template-columns:1fr} }
    select, input[type="text"], input[type="email"], input[type="date"]{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;
      font-size:15px;outline:none;transition: box-shadow .15s, border-color .15s;
    }
    select:focus, input:focus{ border-color: var(--brand); box-shadow:0 0 0 4px var(--ring); }
    .btnbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .btn{ --bg:#e2e8f0; --fg:#0f172a; appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;
      cursor:pointer;transition: transform .06s ease, box-shadow .2s ease, background .2s; box-shadow:0 6px 16px rgba(15,23,42,.08);
      color:var(--fg);background:var(--bg); }
    .btn:active{transform: translateY(1px)}
    .btn.primary{ --bg: var(--accent); --fg:#fff }
    .btn.pause{ --bg:#f59e0b; --fg:#111827 }
    .btn.unpause{ --bg: var(--brand); --fg:#fff }
    .btn.finish{ --bg: var(--accent); --fg:#fff }
    .btn.extra{ --bg:#64748b; --fg:#fff }
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .leave{ border:1px dashed #cbd5e1;border-radius:14px;padding:12px;background:#f8fafc; }
    .kicker{font-size:12px;color:var(--muted);margin-bottom:6px}
    .status{font-size:13px;color:var(--muted);margin-top:10px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;white-space:pre-wrap}
    .chip{ display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(81,106,117,.10);color:#2f3e45;font-weight:600;font-size:12px }
    .rail{padding:18px}
    .summary{ display:grid;gap:12px }
    .summary .item{ display:flex;align-items:center;gap:10px;padding:12px;border-radius:14px;background:#f8fafc;border:1px solid #e2e8f0; }
    .footer{ margin-top:18px;font-size:12px;color:var(--muted);text-align:center }
    .ok{color:#15803d} .err{color:#ef4444} .warn{color:#a16207}

    /* ===== Toast privat ===== */
    .toast{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: 24px; z-index: 9999; min-width: 280px; max-width: 92vw;
      background: #0f172a; color: #fff; border-radius: 14px; padding: 14px 16px;
      box-shadow: 0 20px 50px rgba(2,6,23,.35); display:none; font-size:14px
    }
    .toast.ok{ background:#166534 }
    .toast.warn{ background:#a16207 }
    .toast.err{ background:#991b1b }
    .toast .small{opacity:.85;font-size:12px;margin-top:4px}
  </style>
</head>
<body>
  <div class="shell">
    <nav class="nav card">
      <a class="brand" href="#" aria-label="Spre început">
        <img src="favicon.png" alt="Siglă SERVELECT" />
        <div>
          <h1><span>SERVELECT</span><small>Pontaj & Management Concedii</small></h1>
        </div>
      </a>
      <div class="chip" id="cfg">Se încarcă configurația…</div>
    </nav>

    <section class="hero">
      <div class="card panel">
        <header>
          <span class="dot" aria-hidden="true"></span>
          <h2>Înregistrare activitate</h2>
        </header>
        <p class="sub">Alege <b>Departament</b> → <b>Angajat</b>, apoi <b>Tip de activitate</b>, completează <b>Locația</b> și (opțional) o <b>Notă</b>. Apoi folosește butoanele de mai jos.</p>

        <div class="grid cols-3">
          <div>
            <label for="deptSelect">Departament</label>
            <select id="deptSelect"><option value="" selected disabled>Alege departamentul...</option></select>
          </div>

          <div>
            <label for="employeeSelect">Angajat</label>
            <select id="employeeSelect"><option>Se încarcă...</option></select>
            <div class="status" id="empStatus"></div>
          </div>

          <div>
            <label for="activitySelect">Tip de activitate</label>
            <select id="activitySelect">
              <option value="" selected disabled>Alege tip...</option>
              <option>atelier</option>
              <option>birou-lucrare</option>
              <option>deplasare</option>
              <option>ofertare</option>
              <option>concediu de odihna</option>
              <option>concediu medical</option>
              <option>zi libera legala</option>
              <option>birou-administrativ</option>
              <option>home office</option>
              <option>invoire</option>
              <option>pe drum</option>
              <option>concediu pentru ore suplimentare</option>
              <option>birou + deplasare</option>
            </select>
          </div>

          <div>
            <label for="locationInput">Locație</label>
            <input id="locationInput" type="text" placeholder="ex: Șantier B – Poartă 2" />
          </div>
        </div>

        <div class="grid" style="margin-top:12px">
          <div>
            <label for="notes">Notă (opțional)</label>
            <input id="notes" type="text" placeholder="ex: Proiect X, client Y" />
          </div>
        </div>

        <!-- Leave panel -->
        <div id="leavePanel" class="leave" style="display:none;margin-top:16px">
          <div class="kicker"><b>Cerere concediu</b> — adaugă <b>zile individuale</b> de concediu, apoi completează emailul personal și (opțional) o notă. Se trimite automat la HR.</div>

  <div class="grid cols-3" id="leaveDaysBlock">
    <div>
      <label for="leaveDay">Zi concediu</label>
      <input type="date" id="leaveDay" />
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="btnAddDay" class="btn extra" type="button" style="width:100%">Adaugă zi</button>
    </div>
    <div>
      <label>Zile selectate</label>
      <div id="leaveDaysList" class="status" style="min-height:44px"></div>
    </div>
  </div>
          <div class="grid cols-3">
            <div>
              <label for="leaveStart">Data start</label>
              <input type="date" id="leaveStart" />
            </div>
            <div>
              <label for="leaveEnd">Data sfârșit</label>
              <input type="date" id="leaveEnd" />
            </div>
            <div>
              <label for="leaveEmail">Email personal</label>
              <input type="email" id="leaveEmail" placeholder="ex: prenume.nume@..." />
            </div>
          </div>
          <div class="grid" style="margin-top:10px">
            <div>
              <label for="leaveNotes">Notă către HR (opțional)</label>
              <input type="text" id="leaveNotes" placeholder="ex: motiv / detalii" />
            </div>
          </div>
          <div class="btnbar">
            <button id="btnLeave" class="btn primary" type="button">Trimite cererea de concediu</button>
            <span class="status" id="leaveStatus"></span>
          </div>
        </div>

        <!-- Main action buttons -->
        <div class="btnbar" style="margin-top:16px">
          <button class="btn primary" id="btnStart">Start</button>
          <button class="btn pause"   id="btnPause">Pause</button>
          <button class="btn unpause" id="btnUnpause">Unpause</button>
          <button class="btn finish"  id="btnFinish">Finish</button>
        </div>

        <!-- EXTRA time buttons -->
        <div class="btnbar" style="margin-top:8px">
          <button class="btn extra" id="btnExtraStart" title="Pornește orele extra (separate de suplimentare)">Extra Start</button>
          <button class="btn extra" id="btnExtraFinish" title="Încheie orele extra">Extra Finish</button>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>

        <!-- Ascuns: blocul de debug JSON NU mai e folosit -->
        <div id="last" class="status mono" style="display:none"></div>
      </div>

      <!-- Right: Helper / Summary -->
      <aside class="card rail">
        <header style="display:flex;align-items:center;gap:10px;margin:4px 0 10px">
          <span class="dot" aria-hidden="true"></span>
          <h2 style="margin:0;font-size:18px">Scurt ghid</h2>
        </header>
        <div class="summary">
          <div class="item"><b>Start</b> pornește pontajul</div>
          <div class="item"><b>Pause</b> / <b>Unpause</b> marchează pauzele.</div>
          <div class="item"><b>Finish</b> încheie ziua de lucru.</div>
          <div class="item"><b>Extra Start/Finish</b> — ore extra separate de suplimentare.</div>
          <div class="item"><b>Concedii</b> — alege tipul și trimite cererea.</div>
        </div>
        <div class="footer">© <span id="year"></span> SERVELECT. Toate drepturile rezervate.</div>
      </aside>
    </section>
  </div>

  <!-- Toast privat -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <iframe name="hidden_iframe" style="display:none;"></iframe>
  <iframe name="hidden_iframe_leave" style="display:none;"></iframe>

  <!-- Leave Google Form -->
  <form id="leaveForm" method="POST" target="hidden_iframe_leave">
    <input type="hidden" id="lv_name" />
    <input type="hidden" id="lv_type" />
    <input type="hidden" id="lv_email" />
    <input type="hidden" id="lv_start" />
    <input type="hidden" id="lv_end" />
    <input type="hidden" id="lv_notes" />
    <input type="hidden" id="lv_ts" />
  </form>

  <!-- Main Google Form payload -->
  <form id="gform" method="POST" target="hidden_iframe">
    <input type="hidden" id="f_action" />
    <input type="hidden" id="f_timestamp" />
    <input type="hidden" id="f_name" />
    <input type="hidden" id="f_activity" />
    <input type="hidden" id="f_location" />
    <input type="hidden" id="f_lat" />
    <input type="hidden" id="f_lon" />
    <input type="hidden" id="f_acc" />
    <input type="hidden" id="f_device" />
    <input type="hidden" id="f_notes" />
    <input type="hidden" id="f_maps" />
    <!-- nou: departament -->
    <input type="hidden" id="f_department" />
  </form>

  <!-- Fallback inline employees list -->
  <script type="text/plain" id="employees-inline">
Ion Popescu
Maria Ionescu
Vlad Georgescu
Ana Radu
  </script>

  <script>document.getElementById('year').textContent = new Date().getFullYear();</script>

  <script>
/** ================== Helpers & Config ================== */
function setText(el, msg, cls){ el.className = (el.className.split(' ')[0] || 'status') + (cls?(' '+cls):''); el.textContent = msg; }
function _norm(s){ return String(s==null?'':s).trim(); }
function _normAction(a){
  let s = _norm(a).toLowerCase().replace(/[-\s]+/g,'_');
  if (s === 'resume') s='unpause';
  if (s === 'stop') s='finish';
  if (s === 'extra start') s='extra_start';
  if (s === 'extra finish') s='extra_finish';
  return s;
}
function showToast(msg, type){
  const t = document.getElementById('toast');
  t.className = 'toast' + (type ? ' ' + type : '');
  t.innerHTML = msg;
  t.style.display = 'block';
  clearTimeout(showToast._h);
  showToast._h = setTimeout(()=>{ t.style.display='none'; }, 7000);
}

/** Trimite cererea de concediu la WebApp (fără preflight CORS) */
async function sendLeave(payload) {
  const r = await fetch(CFG.leaveEndpoint, {
    method: 'POST',
    headers: {'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify(payload)
  });
  const txt = await r.text();
  let data;
  try { data = JSON.parse(txt); }
  catch { throw new Error('Răspuns invalid: ' + txt.slice(0,200)); }
  if (!r.ok || !data.ok) throw new Error((data && data.error) || ('HTTP '+r.status));
  return data;
}

(function(){
  const statusEl = document.getElementById('status');
  const cfgEl = document.getElementById('cfg');
  const notesEl = document.getElementById('notes');
  const locInput = document.getElementById('locationInput');
  const deptSel = document.getElementById('deptSelect');
  const empSel = document.getElementById('employeeSelect');
  const actSel = document.getElementById('activitySelect');
  const empStatus = document.getElementById('empStatus');
  const form = document.getElementById('gform');

  const leavePanel = document.getElementById('leavePanel');
  const leaveStart = document.getElementById('leaveStart');
  const leaveEnd = document.getElementById('leaveEnd');
  const leaveEmail = document.getElementById('leaveEmail');
  const leaveNotes = document.getElementById('leaveNotes');
  const leaveStatus = document.getElementById('leaveStatus');
  // Per-day leave selection
  const leaveDay = document.getElementById('leaveDay');
  const leaveDaysList = document.getElementById('leaveDaysList');
  const btnAddDay = document.getElementById('btnAddDay');
  let LEAVE_DAYS = [];

  function renderLeaveDays() {
    if (!leaveDaysList) return;
    leaveDaysList.innerHTML = '';
    if (!LEAVE_DAYS.length) { leaveDaysList.textContent = 'Nicio zi adăugată.'; return; }
    // sort and deduplicate
    LEAVE_DAYS = Array.from(new Set(LEAVE_DAYS)).sort();
    LEAVE_DAYS.forEach((d, idx) => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.style.marginRight = '6px';
      chip.innerHTML = d + ' <button type="button" data-idx="'+idx+'" style="all:unset;cursor:pointer;font-weight:700">×</button>';
      leaveDaysList.appendChild(chip);
    });
  }
  if (btnAddDay) btnAddDay.addEventListener('click', () => {
    const d = (leaveDay && leaveDay.value || '').trim();
    if (!d) { setLeaveStatus('Alege o zi.', 'err'); return; }
    if (!LEAVE_DAYS.includes(d)) LEAVE_DAYS.push(d);
    setLeaveStatus('', '');
    renderLeaveDays();
  });
  if (leaveDaysList) leaveDaysList.addEventListener('click', (ev) => {
    const b = ev.target && ev.target.closest && ev.target.closest('button[data-idx]');
    if (!b) return;
    const i = +b.getAttribute('data-idx');
    if (!isNaN(i)) { LEAVE_DAYS.splice(i,1); renderLeaveDays(); }
  });


  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnUnpause = document.getElementById('btnUnpause');
  const btnFinish = document.getElementById('btnFinish');
  const btnExtraStart = document.getElementById('btnExtraStart');
  const btnExtraFinish = document.getElementById('btnExtraFinish');

  function setStatus(m, c){ setText(statusEl, m, c); }
  function setCfg(m, c){ setText(cfgEl, m, c); }
  function setEmp(m, c){ setText(empStatus, m, c); }
  function setLeaveStatus(m, c){ setText(leaveStatus, m, c); }

  let CFG = null;
  let STATE = blankState();
  const LS_KEY = 'pontaj/state/v1';

  function blankState(){
    return {
      name: '',
      normal: { running:false, paused:false },
      extra:  { running:false },
      lastNormalStart: null,
      lastNormalFinish: null,
      lastExtraStart: null,
      lastExtraFinish: null
    };
  }
  function loadLS(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch{return null;} }
  function saveLS(){ try { localStorage.setItem(LS_KEY, JSON.stringify(STATE)); } catch{} }

  function bindCFGToForm() {
    form.action = CFG.formAction;
    const names = CFG.fields;
    const idMap = {
      'f_action':   names.action,
      'f_timestamp':names.timestamp,
      'f_name':     names.name,
      'f_activity': names.activityType,
      'f_location': names.location,
      'f_lat':      names.latitude,
      'f_lon':      names.longitude,
      'f_acc':      names.accuracy,
      'f_device':   names.device,
      'f_notes':    names.notes,
      'f_maps':     names.mapsLink,
      // nou: dacă există în config.json -> fields.department
      'f_department': names.department || ''
    };
    Object.entries(idMap).forEach(([id,name]) => {
      const el = document.getElementById(id);
      if (name) el.setAttribute('name', name);
    });
  }

  function bindLeaveForm() {
    if (!CFG.leaveFormAction || !CFG.leaveFields) return false;
    const m = CFG.leaveFields;
    const map = {
      'lv_name':  m.name,
      'lv_type':  m.activityType,
      'lv_email': m.personalEmail,
      'lv_start': m.startDate,
      'lv_end':   m.endDate,
      'lv_notes': m.notes,
      'lv_ts':    m.timestamp
    };
    Object.entries(map).forEach(([id, name]) => {
      const el = document.getElementById(id);
      if (el && name) el.setAttribute('name', name);
    });
    document.getElementById('leaveForm').action = CFG.leaveFormAction;
    return true;
  }

  /** ===== EMPLOYAȚI & DEPARTAMENTE ===== */

  // Employees CSV (folosit doar ca fallback)
  function parseEmployeesCSV(text){
    if (text && text.charCodeAt && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    text = (text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
    if (!text) return [];
    if (!/,|;/.test(text)) {
      return text.split('\n').map(s => s.trim()).filter(Boolean);
    }
    const comma = (text.match(/,/g) || []).length;
    const semiCount = (text.match(/;/g) || []).length;
    const delim = semiCount > comma ? ';' : ',';
    const rows = text.split('\n')
      .map(line => line.split(delim).map(c => c.trim().replace(/^"|"$/g,'')))
      .filter(r => r.length && r.join('').length);
    const header = rows[0].map(h => (h||'').toLowerCase());
    let startIdx = 0, nameCol = 0;
    if (header.some(h => /angajat|nume|employee|name/.test(h))) {
      nameCol = Math.max(0, header.findIndex(h => /angajat|nume|employee|name/.test(h)));
      startIdx = 1;
    }
    const list = [];
    for (let i=startIdx;i<rows.length;i++){
      const v = (rows[i][nameCol] || '').trim();
      if (v) list.push(v);
    }
    return list;
  }
  function getInlineEmployees(){
    const el = document.getElementById('employees-inline');
    if (!el) return [];
    return el.textContent.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  }

  // Departments CSV (sursa principală)
  function parseDepartmentsCSV(text){
    if (text && text.charCodeAt && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    text = (text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
    if (!text) return { byDept:new Map(), byName:new Map(), deptList:[] };

    const lines = text.split('\n').filter(Boolean);
    // suportă , sau ;
    const sep = (text.indexOf(';') > -1 && (text.indexOf(';') < text.indexOf(','))) ? ';' : ',';

    let start = 0, depCol = 0, nameCol = 1;
    const hdr = lines[0].split(sep).map(s=>s.trim().replace(/^"|"$/g,'').toLowerCase());
    if (hdr.some(h => /depart|dept/.test(h)) || hdr.some(h => /angajat|nume|employee|name/.test(h))) {
      const d = hdr.findIndex(h => /depart|dept/.test(h));
      const n = hdr.findIndex(h => /angajat|nume|employee|name/.test(h));
      if (d >= 0) depCol = d;
      if (n >= 0) nameCol = n;
      start = 1;
    }

    const byDept = new Map();
    const byName = new Map();

    for (let i=start;i<lines.length;i++){
      const cells = lines[i].split(sep).map(s=>s.trim().replace(/^"|"$/g,''));
      const dep = (cells[depCol]||'').trim();
      const nm  = (cells[nameCol]||'').trim();
      if (!dep || !nm) continue;
      if (!byDept.has(dep)) byDept.set(dep, []);
      byDept.get(dep).push(nm);
      byName.set(nm, dep);
    }

    const deptList = Array.from(byDept.keys()).sort((a,b)=>a.localeCompare(b,'ro'));
    for (const d of byDept.keys()) byDept.get(d).sort((a,b)=>a.localeCompare(b,'ro'));
    return { byDept, byName, deptList };
  }

  // State pentru departamente
  let DEPTMAP = { byDept:new Map(), byName:new Map(), deptList:[] };

  function fillDepartments(deptList){
    deptSel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value=''; ph.textContent='Alege departamentul...'; ph.disabled = true; ph.selected = true;
    deptSel.appendChild(ph);
    deptList.forEach(d => { const o=document.createElement('option'); o.value=d; o.textContent=d; deptSel.appendChild(o); });
  }

  function fillEmployeesFromDept(dept){
    const sel = empSel;
    sel.innerHTML = '';
    const ph = document.createElement('option');
    ph.value=''; ph.textContent= dept ? 'Alege angajat…' : 'Alege departamentul mai întâi…';
    ph.disabled = true; ph.selected = true;
    sel.appendChild(ph);
    if (!dept) return;
    const list = (DEPTMAP.byDept.get(dept) || []);
    list.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  }

  async function loadDepartments(){
    // 1) Încearcă departmentsCsv din config
    try{
      if (CFG.departmentsCsv){
        const url = CFG.departmentsCsv + (CFG.departmentsCsv.includes('?') ? '&' : '?') + 'v=' + Date.now();
        const r = await fetch(url, {cache:'no-store'});
        if (r.ok){
          const txt = await r.text();
          const map = parseDepartmentsCSV(txt);
          if (map.deptList.length){
            DEPTMAP = map;
            fillDepartments(map.deptList);
            setEmp('Departamente încărcate din departmentsCsv.', 'ok');
            return;
          }
        }
      }
    }catch(e){}

    // 2) Fallback: dacă nu există departments.csv, construim “productie” din employeesCsv/config/inline
    let fallbackEmployees = [];
    try {
      if (CFG.employeesCsv){
        const url = CFG.employeesCsv + (CFG.employeesCsv.includes('?') ? '&' : '?') + 'v=' + Date.now();
        const r = await fetch(url, {cache:'no-store'});
        if (r.ok) fallbackEmployees = parseEmployeesCSV(await r.text());
      }
    } catch(e){}
    if (!fallbackEmployees.length && Array.isArray(CFG.employees)) fallbackEmployees = CFG.employees.slice();
    if (!fallbackEmployees.length) fallbackEmployees = getInlineEmployees();

    const byDept = new Map([['productie', fallbackEmployees]]);
    const byName = new Map(fallbackEmployees.map(nm => [nm, 'productie']));
    const deptList = ['productie'];
    DEPTMAP = { byDept, byName, deptList };
    fillDepartments(deptList);
    setEmp('Nu există departmentsCsv — folosesc „productie”.', 'warn');
  }

  /** ===== STATE (UI + server) ===== */
  function reflectState(){
    const running = STATE.normal.running;
    const paused  = STATE.normal.paused;
    const extraR  = STATE.extra.running;

    const hasSel = !!empSel.value;
    btnStart.disabled       = !hasSel || running || extraR;
    btnPause.disabled       = !hasSel || !running || paused;
    btnUnpause.disabled     = !hasSel || !running || !paused;
    btnFinish.disabled      = !hasSel || !running;

    btnExtraStart.disabled  = !hasSel || running || extraR;
    btnExtraFinish.disabled = !hasSel || !extraR;
  }
  function disableTimeButtons(disabled) {
    [btnStart,btnPause,btnUnpause,btnFinish,btnExtraStart,btnExtraFinish].forEach(el=>{
      if (el) el.disabled = !!disabled;
    });
  }
  function disableAllButtons(disabled){
    disableTimeButtons(disabled);
    const lbtn = document.getElementById('btnLeave');
    if (lbtn) lbtn.disabled = !!disabled;
  }

  async function fetchState(name){
    const base = (CFG.stateEndpoint && CFG.stateEndpoint.trim()) || (CFG.guardEndpoint && (CFG.guardEndpoint.trim() + '?fn=state'));
    if (!base) return null;
    const url = base.includes('?fn=state') ? (base + '&name=' + encodeURIComponent(name)) 
                                           : (base + (base.includes('?')?'&':'?') + 'name=' + encodeURIComponent(name));
    const r = await fetch(url, { cache:'no-store' });
    const txt = await r.text();
    try { return JSON.parse(txt).state || null; } catch { return null; }
  }

  // Stats (Azi)
  async function fetchStats(name){
    const rawBase = (CFG.guardEndpoint && CFG.guardEndpoint.trim()) || (CFG.stateEndpoint && CFG.stateEndpoint.trim());
    if (!rawBase) return null;
    const base = rawBase.replace(/\?.*$/,'');
    const url = base + '?fn=stats&name=' + encodeURIComponent(name);
    try{
      const r = await fetch(url, { cache:'no-store' });
      const txt = await r.text();
      try { const data = JSON.parse(txt); return data && data.ok ? data.stats : null; }
      catch { return null; }
    }catch{ return null; }
  }

  async function guardRemote(name, action){
    const base = (CFG.guardEndpoint && CFG.guardEndpoint.trim()) || (CFG.stateEndpoint && CFG.stateEndpoint.trim());
    if (!base) return {ok:true};
    const url = base + (base.includes('?') ? '&' : '?') + 'fn=guard';
    try{
      const r = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({ name, action: _normAction(action) })
      });
      const txt = await r.text();
      let data; try { data = JSON.parse(txt); } catch { return {ok:true}; }
      return data;
    }catch{
      return {ok:true};
    }
  }

  function localGuard(action){
    action = _normAction(action);
    const running = STATE.normal.running;
    const paused  = STATE.normal.paused;
    const extraR  = STATE.extra.running;

    switch(action){
      case 'start':
        if (running)  return 'Ai deja un START în derulare.';
        if (extraR)   return 'Finalizează mai întâi „Extra” înainte de a porni norma.';
        return null;
      case 'pause':
        if (!running) return 'Nu poți da PAUSE fără START.';
        if (paused)   return 'Ești deja pe PAUSE.';
        return null;
      case 'unpause':
        if (!running) return 'Nu poți da UNPAUSE fără START.';
        if (!paused)  return 'Nu ești în PAUSE.';
        return null;
      case 'finish':
        if (!running) return 'Nu poți da FINISH fără START.';
        return null;
      case 'extra_start':
        if (running)  return 'Finalizează norma înainte de „EXTRA START”.';
        if (extraR)   return 'Ai deja EXTRA pornit.';
        return null;
      case 'extra_finish':
        if (!extraR)  return 'Nu poți da „EXTRA FINISH” fără „EXTRA START”.';
        return null;
      default:
        return null;
    }
  }

  function applyLocalTransition(action, ts){
    action = _normAction(action);
    switch(action){
      case 'start':
        STATE.normal.running = true;
        STATE.normal.paused  = false;
        STATE.lastNormalStart = ts;
        break;
      case 'pause':
        STATE.normal.paused = true;
        break;
      case 'unpause':
        STATE.normal.paused = false;
        break;
      case 'finish':
        STATE.normal.running = false;
        STATE.normal.paused  = false;
        STATE.lastNormalFinish = ts;
        break;
      case 'extra_start':
        STATE.extra.running = true;
        STATE.lastExtraStart = ts;
        break;
      case 'extra_finish':
        STATE.extra.running = false;
        STATE.lastExtraFinish = ts;
        break;
    }
  }

  function setFormPayload(action, ts, gps){
    document.getElementById('f_action').value    = _normAction(action);
    document.getElementById('f_timestamp').value = ts;
    document.getElementById('f_name').value      = empSel.value;
    document.getElementById('f_activity').value  = actSel.value;
    document.getElementById('f_location').value  = (document.getElementById('locationInput').value||'').trim();
    document.getElementById('f_lat').value       = gps.lat;
    document.getElementById('f_lon').value       = gps.lon;
    document.getElementById('f_acc').value       = gps.acc;
    document.getElementById('f_device').value    = navigator.userAgent;
    document.getElementById('f_notes').value     = (document.getElementById('notes').value || '');
    document.getElementById('f_maps').value      = `https://maps.google.com/?q=${gps.lat},${gps.lon}`;

    // nou: trimitem și departamentul (din select sau din mapare byName)
    const deptFromMap = DEPTMAP.byName.get(empSel.value) || '';
    document.getElementById('f_department').value = (deptSel.value || deptFromMap || '');
  }

  async function refreshServerState(){ 
    if (!STATE.name) return;
    try {
      const remote = await fetchState(STATE.name);
      if (remote) {
        STATE = Object.assign(blankState(), remote);
        STATE.name = empSel.value || STATE.name || '';
        saveLS();
      }
    } catch(e){}
  }

  async function handleEmployeeChange(){
    STATE = blankState();
    STATE.name = empSel.value || '';
    saveLS();

    setEmp('Se verifică starea...', '');
    await refreshServerState();
    reflectState();

    if (STATE.normal.running && STATE.normal.paused) setEmp('Ești în PAUSE.', 'warn');
    else if (STATE.normal.running) setEmp('Ai START activ.', 'ok');
    else if (STATE.extra.running) setEmp('Ai EXTRA activ.', 'ok');
    else setEmp('Nicio sesiune deschisă.', '');
  }

  // ==================== ACTION SUBMIT ====================
  let busy = false;

  async function submitAction(action) {
    if (busy) return;
    if (!deptSel.value) { setStatus('Alege departamentul.', 'err'); return; }
    if (!empSel.value)  { setStatus('Selectează angajat.', 'err'); return; }
    if (!actSel.value)  { setStatus('Alege tip de activitate.', 'err'); return; }
    if (!document.getElementById('locationInput').value.trim()) { setStatus('Scrie o locație.', 'err'); document.getElementById('locationInput').focus(); return; }

    if (['concediu de odihna','concediu medical','concediu pentru ore suplimentare'].includes((actSel.value||'').toLowerCase())){
      setStatus('Pentru concediu folosește „Trimite cererea de concediu”.', 'warn');
      return;
    }

    setStatus('Verific starea…');

    const lg = localGuard(action);
    if (lg) { setStatus(lg, 'warn'); return; }

    const g = await guardRemote(empSel.value.trim(), action);
    if (!g.ok) { setStatus(g.msg || 'Acțiune blocată de regulile de pontaj.', 'warn'); return; }

    if (!('geolocation' in navigator)) { setStatus('Geolocație indisponibilă pe acest dispozitiv.', 'err'); return; }

    busy = true; disableAllButtons(true);
    setStatus('Se obține locația GPS…');

    navigator.geolocation.getCurrentPosition(async pos => {
      const gps = { lat: pos.coords.latitude, lon: pos.coords.longitude, acc: Math.round(pos.coords.accuracy || 0) };
      const ts = new Date().toISOString();

      setFormPayload(action, ts, gps);
      form.submit();

      applyLocalTransition(action, ts);
      saveLS();
      reflectState();
      setStatus(`Trimis ✓ (${_normAction(action).toUpperCase()}).`, 'ok');

      const act = _normAction(action);
      setTimeout(async ()=>{
        await refreshServerState();
        let stats = null;
        try { stats = await fetchStats(empSel.value.trim()); } catch {}
        if (stats){
          if (act === 'finish'){
            showToast(
              `<b>${empSel.value}</b><div class="small">Azi — Ore: <b>${stats.totalHours}</b> h • Suplimentar: <b>${stats.overtime}</b> h</div>`,
              'ok'
            );
          } else if (act === 'extra_finish'){
            showToast(
              `<b>${empSel.value}</b><div class="small">Azi — Extra: <b>${stats.extra}</b> h</div>`,
              'ok'
            );
          }
        }
        busy=false; disableAllButtons(false);
      }, 1200);

    }, err => {
      setStatus('Eroare locație: ' + err.message, 'err');
      busy=false; disableAllButtons(false);
    }, { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 });
  }

  function wireButtons(){
    document.getElementById('btnStart').addEventListener('click', ()=>submitAction('start'));
    document.getElementById('btnPause').addEventListener('click', ()=>submitAction('pause'));
    document.getElementById('btnUnpause').addEventListener('click', ()=>submitAction('unpause'));
    document.getElementById('btnFinish').addEventListener('click', ()=>submitAction('finish'));
    document.getElementById('btnExtraStart').addEventListener('click', ()=>submitAction('extra_start'));
    document.getElementById('btnExtraFinish').addEventListener('click', ()=>submitAction('extra_finish'));
    reflectState();
  }

  /** ===== INIT ===== */
  (async function init(){
    try {
      const r = await fetch('config.json?v=' + Date.now(), {cache:'no-store'});
      if (!r.ok) throw new Error('HTTP ' + r.status);
      CFG = await r.json();
      if (!CFG.formAction || !CFG.fields) throw new Error('Config incomplet');
      setCfg('Config încărcat', 'ok');
      window.CFG = CFG;
    } catch (e) {
      setCfg('Eroare config: ' + (e.message||e), 'err');
      disableAllButtons(true); return;
    }

    bindCFGToForm();
    bindLeaveForm();

    // Încarcă departamentele (sursa primară) + populează employees după departament
    await loadDepartments();
    fillEmployeesFromDept(''); // placeholder până alegi departamentul

    // restaurăm starea locală
    const cached = loadLS();
    if (cached) STATE = Object.assign(blankState(), cached);

    // când schimb departamentul, re-populez angajații și resetez starea selectată
    deptSel.addEventListener('change', () => {
      fillEmployeesFromDept(deptSel.value);
      if (empSel.value && (DEPTMAP.byName.get(empSel.value) !== deptSel.value)) {
        empSel.value = '';
      }
      STATE = blankState(); STATE.name = '';
      reflectState(); setEmp('', '');
    });

    // schimbare angajat — doar starea
    empSel.addEventListener('change', handleEmployeeChange);

    // toggle concedii
    const LEAVE_TYPES = new Set(['concediu de odihna','concediu medical','concediu pentru ore suplimentare']);
    actSel.addEventListener('change', () => {
      const isLeave = LEAVE_TYPES.has((actSel.value||'').toLowerCase());
      leavePanel.style.display = isLeave ? '' : 'none';
      disableTimeButtons(isLeave);
      if (isLeave) { LEAVE_DAYS = []; renderLeaveDays(); setLeaveStatus('', ''); }
    });

    // butoane acțiuni
    wireButtons();

    // buton concedii
    document.getElementById('btnLeave').addEventListener('click', async () => {
      setLeaveStatus('', '');
      if (!deptSel.value) { setLeaveStatus('Alege departamentul.', 'err'); return; }
      if (!empSel.value)  { setLeaveStatus('Selectează angajat.', 'err'); return; }
      const tip = (actSel.value || '').toLowerCase();
      if (!LEAVE_TYPES.has(tip)) { setLeaveStatus('Alege un tip de concediu.', 'err'); return; }
      const sd = leaveStart.value;
      const ed = leaveEnd.value;
      const hasDays = Array.isArray(LEAVE_DAYS) && LEAVE_DAYS.length > 0;
      if (!hasDays) {
        if (!sd || !ed) { setLeaveStatus('Adaugă cel puțin o zi de concediu sau completează intervalul (start–sfârșit).', 'err'); return; }
        if (ed < sd) { setLeaveStatus('Data de sfârșit nu poate fi înainte de start.', 'err'); return; }
      }
      const email = (leaveEmail.value || '').trim();
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setLeaveStatus('Email personal invalid.', 'err'); return; }

      setLeaveStatus('Se trimite cererea…', '');

      // optional: Google Form
      let formSubmitted = false;
      if (CFG.leaveFormAction && CFG.leaveFields) {
        try {
          document.getElementById('lv_name').value  = empSel.value;
          document.getElementById('lv_type').value  = tip;
          document.getElementById('lv_email').value = email;
          const _daysSorted = hasDays ? LEAVE_DAYS.slice().sort() : [];
          const _first = hasDays ? _daysSorted[0] : sd;
          const _last  = hasDays ? _daysSorted[_daysSorted.length-1] : ed;
          document.getElementById('lv_start').value = _first;
          document.getElementById('lv_end').value   = _last;
          document.getElementById('lv_notes').value = (leaveNotes.value || '');
          document.getElementById('lv_ts').value    = new Date().toISOString();
          document.getElementById('leaveForm').submit();
          formSubmitted = true;
        } catch (e) { console.warn('Leave Form submit failed', e); }
      }

      // endpoint WebApp
      let endpointOk = false, endpointMsg = '';
      if (CFG.leaveEndpoint) {
        try {
          const _daysSorted = hasDays ? LEAVE_DAYS.slice().sort() : [];
          const _first = hasDays ? _daysSorted[0] : sd;
          const _last  = hasDays ? _daysSorted[_daysSorted.length-1] : ed;
          const payload = {
            name: empSel.value,
            activityType: tip,
            startDate: _first,
            endDate: _last,
            days: hasDays ? _daysSorted : undefined,
            personalEmail: email,
            notes: (leaveNotes.value || '')
          };
          const res = await sendLeave(payload);
          endpointOk = true;
          endpointMsg = ' (înregistrată ' + res.zile + ' zile)';
        } catch (err) { console.warn('Leave endpoint error:', err); }
      }

      if (formSubmitted || endpointOk) {
        setLeaveStatus('Cerere trimisă' + endpointMsg + '. HR a fost notificat.', 'ok');
        LEAVE_DAYS = []; renderLeaveDays();
      } else {
        setLeaveStatus('Eroare: nu s-a putut trimite cererea (Form/Endpoint).', 'err');
      }
    });

  })();

})(); // IIFE
  </script>
</body>
</html>
